# Session Logs - neurealis ERP

**Stand:** 2026-02-01

---

## Index

| Log-ID | Datum | Titel | Status |
|--------|-------|-------|--------|
| LOG-001 | 2026-01-27 | UI-Migration Phase 1-2: Komplettes internes Portal | Abgeschlossen |
| LOG-002 | 2026-01-27 | Hero API Rechnungssync - invoice_style Entdeckung | Dokumentiert |
| LOG-003 | 2026-01-27 | VBW LV 2026 - Preisvergleich & Materialvorschl√§ge | Abgeschlossen |
| LOG-004 | 2026-01-27 | VBW LV 2026 - Entscheidungsgrundlage v1.1 (Final) | Abgeschlossen |
| LOG-005 | 2026-01-28 | UI CRUD + Netlify Deployment | Abgeschlossen |
| LOG-006 | 2026-01-28 | Hero Document Sync v7 + Datenqualit√§ts-Analyse | Abgeschlossen |
| LOG-007 | 2026-01-28 | OAuth Callback Verifizierung | Abgeschlossen |
| LOG-008 | 2026-01-28 | Hero-Softr Dokumenten-Sync Bereinigung | Abgeschlossen |
| LOG-009 | 2026-01-28 | Dokumenten-Merge + RAG-Vorbereitung | Abgeschlossen |
| LOG-010 | 2026-01-28 | Document Summarization System | Abgeschlossen |
| LOG-011 | 2026-01-28 | Hero Webhook-Recherche + Cron-Optimierung | Abgeschlossen |
| LOG-012 | 2026-01-28 | Hero Document Sync v10 + Monday Bidirektional Sync | Abgeschlossen |
| LOG-013 | 2026-01-28 | Angebotsvergleich ANG-0021296 (Vorher/Nachher) | Abgeschlossen |
| LOG-014 | 2026-01-28 | E-Mail-Integration Phase 1 | Abgeschlossen |
| LOG-015 | 2026-01-28 | Hero PDF-Sync - Vollst√§ndige Migration | Abgeschlossen |
| LOG-016 | 2026-01-28 | Schlussrechnung-Nachweis-Check Edge Function | Abgeschlossen |
| LOG-017 | 2026-01-28 | Hero-Sync Betr√§ge-Bug-Fix + Wiederherstellung | Abgeschlossen |
| LOG-018 | 2026-01-28 | Blog-Pipeline Planung (3-Agenten-System) | Geplant |
| LOG-019 | 2026-01-28 | Wissens-Indizierung f√ºr Blog-Pipeline | Abgeschlossen |
| LOG-020 | 2026-01-29 | Nachweis-Logik Analyse (Ausf√ºhrungsarten) | Abgeschlossen |
| LOG-021 | 2026-01-29 | Wissens-Indizierung Phase 2 (Wettbewerb + Business Plan) | Abgeschlossen |
| LOG-022 | 2026-01-29 | Ausf√ºhrungsart-basierte Nachweis-Filterung v19 | Abgeschlossen |
| LOG-023 | 2026-01-29 | Blog-Pipeline Plan Finalisierung | Abgeschlossen |
| LOG-024 | 2026-01-29 | Dokumentenmanagement-System: Telegram-Bot + SharePoint-Sync | Abgeschlossen |
| LOG-025 | 2026-01-29 | Telegram-Bot v2.0 + Edge Function Backups | Abgeschlossen |
| LOG-026 | 2026-01-29 | Blog-Pipeline Implementierung (T1-T8) | Abgeschlossen |
| LOG-027 | 2026-01-29 | M√§ngel-Erinnerungssystem: 2-Phasen-Logik | Abgeschlossen |
| LOG-028 | 2026-01-29 | SharePoint-Sync: Client Credentials Flow | Abgeschlossen |
| LOG-029 | 2026-01-29 | Blog-Pipeline: Cornerstone 3000-W√∂rter-Artikel | Abgeschlossen |
| LOG-030 | 2026-01-29 | Blog-WordPress-Sync Edge Function | Abgeschlossen |
| LOG-031 | 2026-01-29 | WordPress-Sync v3 + Marketing-RLS-Fix | Abgeschlossen |
| LOG-032 | 2026-01-29 | Telegram-Bot v49 + M√§ngel-Reminder Fix | Abgeschlossen |
| LOG-033 | 2026-01-29 | WordPress-Sync: IONOS Auth-Problem Troubleshooting | Blockiert |
| LOG-034 | 2026-01-30 | Telegram-Bot v50 Debugging + M√§ngel-Reminder Fix | Abgeschlossen |
| LOG-035 | 2026-01-30 | LV-Export PDF Styling Fix | Abgeschlossen |
| LOG-036 | 2026-01-30 | LV-Sync Implementierung (T1-T5) | Abgeschlossen |
| LOG-037 | 2026-01-30 | Telegram-Bot v51 - Verbesserte M√§ngel-Erfassung | Abgeschlossen |
| LOG-038 | 2026-01-30 | GWS LV-Import 2026 Baupreisindex | Abgeschlossen |
| LOG-039 | 2026-01-30 | Softr-Sync mangel_nr Fix + Duplikate-Bereinigung | Abgeschlossen |
| LOG-040 | 2026-01-30 | Telegram-Bot v52-v55 - Nachtrag LV-Position-Matching | Abgeschlossen |
| LOG-041 | 2026-01-31 | Telegram-Bot v54 - Phasen-Filter, Gewerk-Status, Ausf√ºhrungen, Multi-Foto | Abgeschlossen |
| LOG-042 | 2026-01-31 | Telegram-Bot Phase 3+4 Nachtplan (Termine, Sprach-Befehle) | Geplant |
| LOG-041 | 2026-01-31 | CPQ-System QA-Pruefung (T6) | Abgeschlossen |
| LOG-041 | 2026-01-31 | Telegram-Bot v58 - Embedding-basierte LV-Suche + lv-embed-regenerate | Abgeschlossen |
| LOG-042 | 2026-01-31 | Nachtrag-Bug-Fix + gemeldet_von + LV-Konsolidierung | Abgeschlossen |
| LOG-043 | 2026-01-31 | Angebot aus Baubesprechungs-Transkription (ATBS-472) | Abgeschlossen |
| LOG-044 | 2026-01-31 | Hero LV-Bereinigung: Duplikate, Alt-Versionen, Artikelnummern | Abgeschlossen |
| LOG-045 | 2026-01-30 | Angebots-CPQ Konzept: Transkription‚ÜíAngebot Tool + Aufma√ü-Geometrien | Konzept fertig |
| LOG-046 | 2026-01-30 | Angebots-CPQ Backend: DB-Migration + LV-Abh√§ngigkeiten + transcription-parse | Abgeschlossen |
| LOG-047 | 2026-01-31 | Angebots-CPQ Vollst√§ndig: UI-Wizard + Drag&Drop + Lern-System | Abgeschlossen |
| LOG-048 | 2026-01-31 | T5: SEO-L√ºcken schlie√üen (Tags, Kategorien, Featured Images) | Abgeschlossen |
| LOG-049 | 2026-01-31 | T9: Broken Links finden und fixen | Abgeschlossen |
| LOG-050 | 2026-01-31 | CPQ-Bugfixes: Projektauswahl, transcription-parse v3, Umlaute | Abgeschlossen |
| LOG-050 | 2026-01-31 | T10: WordPress REST API Discovery | Abgeschlossen |
| LOG-051 | 2026-01-31 | WordPress-Sync IONOS-Fix + Blog-Optimierung (T1-T13) | Abgeschlossen |
| LOG-052 | 2026-01-31 | CPQ-Workflow Fix: Fehlerbehandlung + transcription-parse v7 | Abgeschlossen |
| LOG-053 | 2026-02-01 | CPQ-Test + UI-Verbesserungen dokumentiert | Abgeschlossen |
| LOG-054 | 2026-01-31 | CPQ-Verbesserungen: 7 Features implementiert (T1-T4) | Abgeschlossen |
| LOG-055 | 2026-02-01 | Telegram-Bot v71: Phasen-Bug-Fix + monday_bauprozess Flattening | Abgeschlossen |
| LOG-056 | 2026-02-01 | Monday Board Column Mapping: 338 Spalten dokumentiert | Abgeschlossen |
| LOG-057 | 2026-02-01 | Monday Bidirektional Sync: 3-Agenten-Implementierung | Abgeschlossen |
| LOG-058 | 2026-02-01 | Monday Push: Trigger statt Cron | Abgeschlossen |
| LOG-059 | 2026-02-01 | Telegram-Bot v58: Universelle Sprachbefehle | Abgeschlossen |
| LOG-060 | 2026-02-01 | Telegram-Bot User Guide PDF + Feature-Analyse + Roadmap-Planung | Abgeschlossen |
| LOG-061 | 2026-02-01 | Sync-Optimierung Konzept: Bidirektional + Last-Write-Wins | Abgeschlossen |
| LOG-062 | 2026-02-01 | Sync P1-Tasks: SharePoint Debug, Monday Labels, Softr Push | Abgeschlossen |
| LOG-063 | 2026-02-01 | Audio-Briefing v2.1 + Telegram-Bot v73 BV-Anzeige | Abgeschlossen |
| LOG-064 | 2026-02-01 | monday_bauprozess Spalten-Umbenennung mit Pr√§fixen | Abgeschlossen |
| LOG-065 | 2026-02-01 | SharePoint Sites Katalogisierung + Muster-Analyse | Abgeschlossen |
| LOG-066 | 2026-02-01 | Monday-Sync Initial + verify_jwt Fix | Abgeschlossen |
| LOG-067 | 2026-02-01 | Telegram-Bot v74: Status/Gewerke kombiniert + Men√º-Optimierung + PDF | Abgeschlossen |
| LOG-067 | 2026-02-01 | Learnings Summary: Kompakter Index f√ºr Preflight | Abgeschlossen |
| LOG-068 | 2026-02-01 | SharePoint Initial-Sync: Rate-Limiting-Fix v13 | Abgeschlossen |

---

## LOG-068 - SharePoint Initial-Sync: Rate-Limiting-Fix v13
**Datum:** 2026-02-01 19:15
**Status:** Abgeschlossen

### Ausgangslage
- SharePoint-Sync f√ºr 12 Sites sollte Initial-Sync starten
- 49 SharePoint Sites katalogisiert, 12 f√ºr Wohnungssanierung konfiguriert
- Bisheriger Stand: 45 Dokumente synchronisiert (aus fr√ºherer Session)

### Problem erkannt
3 parallele Subagenten (T1, T2, T3) synchronisierten Sites:
- **Alle Downloads schlugen fehl** trotz korrekter Delta-Query
- Root Cause: **Microsoft Graph API Rate-Limiting (429)**
- ~2.500 Download-Fehler insgesamt

### Analyse (T1-T3 Ergebnisse)
| Agent | Sites | Erkannte Dateien | Download-Fehler |
|-------|-------|-----------------|-----------------|
| T1 | Projekte, Kunden, Marketing, Operations | 780+ | 780 (429) |
| T2 | Nachunternehmer, Gro√ühandel, Vertrieb, Finanzen | 946+ | 946 (429) |
| T3 | Management, Personal, Wohnungssanierung (2x) | 797+ | 797 (429) |

### L√∂sung: sharepoint-sync v13
| √Ñnderung | v11 | v13 |
|----------|-----|-----|
| ITEM_CONCURRENCY | 3 (parallel) | 1 (sequentiell) |
| REQUEST_DELAY_MS | 0 | 500 |
| 429-Handling | Fehler | Retry mit Exponential Backoff |
| Max Retries | - | 3 |

### Deployment
- sharepoint-sync v13 deployed
- Download-Funktion mit Retry-Logik bei 429
- Sequentielle Verarbeitung mit 500ms Delay

### N√§chster Schritt
Test mit v13 auf kleiner Site (00Vertrieb)

---

## LOG-067 - Learnings Summary: Kompakter Index f√ºr Preflight
**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Problem
- `docs/learnings.md` hat 164 Learnings (~2.600 Zeilen, >25.000 Tokens)
- Read-Tool √ºberschreitet Token-Limit
- Preflight konnte Learnings nicht vollst√§ndig laden

### L√∂sung (Option C: Kompakt-Index)
1. `learnings_summary.md` generiert (kompakte Tabellen mit Titel + 1-Zeiler)
2. CLAUDE.md angepasst: Preflight liest Summary statt Volltext
3. `/pre` Skill-Definition aktualisiert (global + projekt)
4. Volltext bleibt verf√ºgbar bei Bedarf (mit offset/limit)

### Ge√§nderte Dateien
| Datei | √Ñnderung |
|-------|----------|
| `docs/learnings_summary.md` | **NEU** - 162 Learnings als kompakter Index |
| `C:\Users\holge\docs\learnings_summary.md` | **NEU** - 78 globale Learnings |
| `C:\Users\holge\CLAUDE.md` | Preflight-Anweisung aktualisiert |
| `C:\Users\holge\.claude\commands\pre.md` | Summary statt Volltext |
| `.claude\commands\pre.md` | Summary statt Volltext |

### Ergebnis
- Preflight l√§dt jetzt ~500 Zeilen statt ~2.600 Zeilen
- Alle Learnings bleiben erhalten (keine Archivierung)
- Volltext bei Bedarf mit `offset/limit` lesbar

---

## LOG-065 - SharePoint Sites Katalogisierung + Muster-Analyse
**Datum:** 2026-02-01 18:00
**Status:** Abgeschlossen

### Durchgef√ºhrte Arbeiten

**1. SharePoint Sites vollst√§ndig katalogisiert:**
- 49 SharePoint-Sites gefunden (davon 12 Wohnungssanierung-relevant)
- `sharepoint-sites` Edge Function f√ºr Auflistung genutzt
- Dokumentation: `docs/sharepoint_sites.json`, `docs/SHAREPOINT_SITES.md`

**2. SharePoint-Sync auf 12 Sites erweitert:**
- 6 neue Sites hinzugef√ºgt (Personal, Operations, Nachunternehmer, Gro√ühandel, Vertrieb, Technik)
- `sharepoint-sync` v10 deployed
- Sicherheitsstufen konfiguriert (Stufe 1-4)

**3. Verzeichnisstruktur analysiert:**
- 42 Top-Level-Ordner, 365 Unterordner dokumentiert
- Standard-Projektstruktur erkannt (01-30 nummerierte Ordner)
- `sharepoint-folders` Edge Function erstellt

**4. Muster-Analyse:**
- Erkannte Muster: ATBS-Nummern (60%), ISO-Datum (55%), nummerierte Ordner
- Inkonsistenzen: Auftraggeber-Schreibweise, Projekte ohne ATBS, Legacy Google Drive Links (53%)
- Dokumentation: `docs/SHAREPOINT_MUSTER_ANALYSE.md`

### Sync-Status

| Kategorie | Wert |
|-----------|------|
| Gesamt SharePoint | 112 GB |
| Supabase Docs | 45 (0,05%) |
| Sites mit Sync-State | 1 von 12 |
| Initial-Sync ausstehend | 11 Sites |

### Neue Learnings
- L160: SharePoint Sites via MS Graph API katalogisieren
- L161: Ordnerstruktur-Muster (01-30 nummerierte Ordner)
- L162: Delta-Query braucht Initial-Sync pro Site

---

## LOG-063 - Audio-Briefing v2.1 + Telegram-Bot v73 BV-Anzeige
**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Durchgef√ºhrte Arbeiten

**1. Audio-Briefing v2.1 deployed:**
- Speed auf 0.75 (langsamer f√ºr besseres Verst√§ndnis)
- Keine Budgets/Betr√§ge im Audio
- Edge Function `audio-briefing-generate` aktualisiert
- Erfolgreich getestet: Briefing an Telegram gesendet

**2. Dummy-Leads gel√∂scht:**
- 8 Test-Leads aus `leads`-Tabelle entfernt

**3. Telegram-Bot v73 - BV-Anzeige √ºberarbeitet:**
- Google Maps Link f√ºr Route
- Kunde-Anzeige: Gesch√§ftskunde vs. Privatkunde
- NU korrekte Felder: `nachunternehmer`, `ansprechpartner`, `telefon_ansprechpartner`
- Neue Termin-Labels: BV Start, BV Ende NU Plan, BV Ende Kunde

**4. Neue Learnings:**
- L143: Audio-Generierung NUR auf Edge Functions
- L144: NU-Felder in monday_bauprozess (Mapping dokumentiert)

### NU-Feld-Mapping (WICHTIG)
| Monday-Spalte | Supabase-Spalte |
|---------------|-----------------|
| Nachunternehmer | `nachunternehmer` |
| Ansprechpartner \| NU | `ansprechpartner` |
| Telefon \| NU | `telefon_ansprechpartner` |
| E-Mail \| NU | `email_ansprechpartner` |

---

## LOG-062 - Sync P1-Tasks: SharePoint Debug, Monday Labels, Softr Push

**Datum:** 2026-02-01 14:00-14:45
**Status:** Abgeschlossen

### Aufgabe

3 parallele P1-Tasks aus dem Sync-Optimierung-Konzept implementieren:
1. SharePoint Token-Problem debuggen
2. Monday Label-Mapping aufbauen
3. Softr bidirektionalen Push implementieren

### Ergebnisse

**T1: SharePoint Debug**
- Problem: Delegated Access Token abgelaufen (28. Januar)
- L√∂sung: `sharepoint-debug` Edge Function deployed
- Function erneuert Token automatisch via Refresh Token
- Sync l√§uft wieder: 1643 Dateien synchronisiert

**T2: Monday Label-Mapping**
- `monday_label_mapping` Tabelle erstellt
- `monday-label-sync` Edge Function v1 deployed
- **327 Labels** aus 76 Status/Color-Spalten geladen
- `monday-push` v6 (Version 11) mit `getLabelIndex()` Lookup
- Test erfolgreich: Keine "label doesn't exist" Fehler mehr

**T3: Softr Bidirektional Push**
- Problem: Falsche API-URL (`studio-api` statt `tables-api`)
- `softr-push` v3 (Version 13) korrigiert mit Fallback-Credentials
- Trigger aktiv auf 5 Tabellen: nachtraege, kontakte, maengel_fertigstellung, tasks, leads
- Test erfolgreich: 14 Felder in 818ms synchronisiert

### Neue Edge Functions

| Function | Version | Status |
|----------|---------|--------|
| `sharepoint-debug` | v1 | ACTIVE |
| `monday-label-sync` | v1 | ACTIVE |
| `monday-push` | v6 (11) | ACTIVE |
| `softr-push` | v3 (13) | ACTIVE |

### Koordination

- 3-Agenten-Modell: T1, T2, T3 parallel gestartet
- PM (Hauptagent) koordinierte und fixte Softr API-Problem
- Koordinationsdatei: `docs/implementation/sync_p1_koordination.md`

---

## LOG-061 - Sync-Optimierung Konzept: Bidirektional + Last-Write-Wins

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

Komplette Analyse und Konzepterstellung f√ºr die Optimierung aller Daten-Synchronisierungen im neurealis ERP.

### Analyse durchgef√ºhrt

**8 Sync-Systeme analysiert:**
| System | Aktuell | Ziel |
|--------|---------|------|
| Monday ‚Üî Supabase | 81‚Üì/17‚Üë Spalten | Alle 338 bidirektional |
| Softr ‚Üî Supabase | Unidirektional | Bidirektional (16 Tabellen) |
| Hero LV | 22‚Üì/6‚Üë | Aktueller Stand reicht |
| E-Mail Sync | T√§glich 03:00 | St√ºndlich 7-19 Uhr |
| SharePoint | Blockiert | Debugging n√∂tig |
| Kontakte | 3 Quellen chaotisch | Hybrid Auto+Manual |

### User-Entscheidungen (Dialog)

| Bereich | Entscheidung |
|---------|--------------|
| SharePoint | Credentials OK, Admin Consent OK ‚Üí Problem woanders |
| Softr | Alle 16 Tabellen bidirektional |
| Konflikte | Last-Write-Wins (neuester Timestamp) |
| Monday Labels | Label-Mapping erstellen f√ºr 64 Status-Spalten |
| Kontakte | Hybrid: Auto nach Rolle + manuelle √úberschreibung |
| E-Mail | Auto-Match + Review-Queue (<80% Confidence) |
| WordPress | Portfolio + Services + regionale Landingpages |
| Hero LV | Nicht weiter ausbauen |

### Ergebnis

**Konzept-Dokument erstellt:** `docs/SYNC_OPTIMIERUNG_KONZEPT.md`

**Roadmap (4 Wochen, ~60h):**
- Woche 1: SharePoint Debugging + Monday Labels
- Woche 2: Softr Bidirektional
- Woche 3: Kontakte + E-Mail Queue
- Woche 4: WordPress/Elementor

### Neue Decisions

D042-D047 dokumentiert (Softr, Monday Labels, Kontakte, E-Mail, WordPress, Grundprinzip)

---

## LOG-057 - Monday Bidirektional Sync: 3-Agenten-Implementierung

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

Vollst√§ndigen bidirektionalen Sync zwischen Monday.com und Supabase implementieren mit 3-Agenten-Modell (Schema, Sync, Trigger).

### Ergebnis

**Edge Functions deployed:**
| Function | Version | Richtung | Spalten |
|----------|---------|----------|---------|
| `monday-sync` | v2 (16) | Monday ‚Üí Supabase | 81 |
| `monday-push` | v3 (8) | Supabase ‚Üí Monday | 17 |

**Cron-Jobs aktiv:**
- `monday-sync-job`: Alle 5 Min (Monday ‚Üí Supabase)
- `monday-push-job`: Alle 5 Min versetzt (Supabase ‚Üí Monday)

**Loop-Vermeidung:**
- `sync_source` Spalte: 'monday' vs 'supabase'
- Trigger `trg_monday_bauprozess_change` setzt automatisch `sync_source = 'supabase'`

**Test-Ergebnisse:**
- monday-sync: 201 Items, 0 Fehler, 43s
- monday-push: 50 Items, 0 Fehler, 105s

**Bekannte Einschr√§nkungen:**
- Status-Spalten nur Monday ‚Üí Supabase (Label-Mismatch-Probleme)
- 17 von 81 Spalten bidirektional (nur Text, Number, Date, Link)

### Neue Dateien

- `docs/MONDAY_COLUMN_MAPPING.md`
- `docs/monday_column_mapping.json`
- `docs/implementation/monday_bidirektional_koordination.md`
- `functions/supabase/functions/monday-push/index.ts`

### Neue Learnings

- L151: Monday Status-Spalten nicht bidirektional
- L152: Supabase .or() mit Spaltenvergleich problematisch

---

## LOG-058 - Monday Push: Trigger statt Cron

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

monday-push von Cron-Job auf DB-Trigger umstellen f√ºr sofortige Reaktion bei Supabase-√Ñnderungen.

### Ergebnis

**Neue Architektur:**
| Richtung | Mechanismus | Details |
|----------|-------------|---------|
| Monday ‚Üí Supabase | Cron (5 Min) | `monday-sync-job` bleibt |
| Supabase ‚Üí Monday | **Trigger** | `trg_monday_push` feuert sofort |

**Implementierung:**
- `trigger_monday_push()`: PL/pgSQL Function mit pg_net.http_post
- `trg_monday_push`: AFTER UPDATE Trigger auf relevanten Spalten
- `monday-push` v5: Unterst√ºtzt Trigger-Modus mit einzelner `item_id`
- `monday-push-job`: Cron **deaktiviert**

**√úberwachte Spalten:**
- atbs_nummer, status_projekt, auftraggeber, bauleiter
- adresse, nachunternehmer, budget, baustart, bauende
- hero_projekt_id, sharepoint_link, matterport_link

**Loop-Vermeidung:**
- WHEN-Klausel: `NEW.sync_source IS DISTINCT FROM 'monday'`
- Trigger ignoriert √Ñnderungen von monday-sync

**Test erfolgreich:**
- Budget-√Ñnderung ‚Üí Trigger feuert ‚Üí Edge Function aufgerufen ‚Üí Monday aktualisiert
- Response: `{"success":true,"mode":"trigger","items_pushed":1,"duration_ms":1736}`

### Neue Learnings

- L153: pg_net Trigger ohne Auth bei verify_jwt=false
- L153: 3-Agenten-Modell f√ºr komplexe Implementierungen

---

## LOG-059 - Telegram-Bot v58: Universelle Sprachbefehle

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

Sprachbefehle f√ºr ALLE Aspekte (au√üer Bedarfsanalyse/Aufma√ü) aus Haupt- und Untermen√ºs erm√∂glichen. User sollen Befehle wie "456 Elektrik fertig" direkt eingeben k√∂nnen, ohne erst ein Projekt zu √∂ffnen.

### Ergebnis

**4 parallele Subagenten:**
| Agent | Aufgabe | Ergebnis |
|-------|---------|----------|
| T1 | STATUS_MAPPING + GEWERK_SPALTEN | 6 Monday-IDs korrigiert, 7 Gewerke gemappt |
| T2 | Sprach-Befehle aus Hauptmen√º | ATBS-Extraktion, Projekt-Suche |
| T3 | Erweiterte Parser | Datum (Wochen, KW, Monat), M√§ngel/Nachtr√§ge |
| T4 | QA-Review | 2 Bugs gefixt (Version, TERMIN_TYPEN-Duplikat) |

**Korrigierte Monday-Spalten-IDs:**
| Gewerk | Alte ID (falsch) | Neue ID (korrekt) |
|--------|------------------|-------------------|
| Elektrik | `06reu` | `color58__1` |
| Sanit√§r | `GnADf` | `color65__1` |
| Maler | `uJfDu` | `color63__1` |
| Boden | `SqOwb` | `color8__1` |
| Tischler | `xhsH6` | `color98__1` |
| Entkernung | `gg2On` | `color05__1` |

**Neue Features:**
- "456 Elektrik fertig" ‚Üí Status ohne offenes Projekt √§ndern
- "√ñffne Bollwerkstra√üe" ‚Üí Projekt per Name suchen
- "Status 456" ‚Üí Projekt direkt √∂ffnen
- "in 2 Wochen", "KW 12", "Ende M√§rz" ‚Üí Erweiterte Datum-Formate
- GEWERK_ALIASES: "Elektro" ‚Üí "Elektrik", "Bad" ‚Üí "Sanit√§r"

**Deployment:**
- `telegram-webhook` v58 deployed
- Koordinationsdatei: `docs/implementation/telegram_sprachbefehle_universal_koordination.md`

### Neue Learnings

- L152: Monday Gewerk-Status-Spalten haben andere IDs als erwartet
- L153: Sprach-Befehle ohne Projekt-Kontext erm√∂glichen

---

## LOG-060 - Telegram-Bot User Guide PDF + Feature-Analyse + Roadmap-Planung

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

1. User Guide PDF f√ºr Bauleiter erstellen (druckfertig)
2. Vollst√§ndige Feature-Analyse des Telegram-Bots (implementiert vs. offen)
3. Roadmap-Planung mit Kl√§rungsfragen f√ºr n√§chste Entwicklungsphase

### Ergebnis

**PDF User Guide:**
- `docs/TELEGRAM_BOT_USER_GUIDE.html` - HTML-Quelle
- `docs/TELEGRAM_BOT_USER_GUIDE.pdf` - Druckfertiges PDF (2 Seiten A4)
- Inhalt: Projekt √∂ffnen, Sprachbefehle, M√§ngel, Nachtr√§ge, Nachweise, Termine

**Feature-Analyse (3 parallele Agenten):**
| Agent | Aufgabe | Ergebnis |
|-------|---------|----------|
| T1 | Implementierte Features | 43 von 47 Features vollst√§ndig implementiert |
| T2 | Offene/geplante Features | Nummerierung, Tages-Dashboard, Admin-Section |
| T3 | Produktivit√§ts-Features | 15 neue Feature-Vorschl√§ge f√ºr Bauleiter |

**Identifizierte Gaps:**
| Problem | Status |
|---------|--------|
| M√§ngel-Nummerierung fehlt | ‚ùå Nicht implementiert |
| Nachtrag-Format falsch | ‚ùå `NT-456-1` statt `ATBS-456-N1` |
| Admin-Section fehlt | ‚ùå Nicht implementiert |
| Tages-Dashboard fehlt | ‚ùå Nicht implementiert |

**Geplante Features (Backlog):**
- Tages-Dashboard mit Terminen und √ºberf√§lligen M√§ngeln
- NU-Anbindung per Telegram (Konzept erstellen)
- Baustellenbegehungsberichte als Dokument
- Admin-Section mit CRUD-Berechtigungen
- Erinnerungen per Sprache (Backlog)

**Kl√§rungsfragen gestellt:** 9 Themenbl√∂cke f√ºr n√§chste Session

### Neue Learnings

- L154: Telegram-Bot User Guide als HTML‚ÜíPDF f√ºr schnelle Dokumentation
- L155: Feature-Analyse mit 3 parallelen Subagenten (implementiert/offen/neu)

### N√§chste Schritte

1. Kl√§rungsfragen beantworten
2. `docs/TELEGRAM_BOT_ROADMAP.md` erstellen
3. `docs/NU_ANBINDUNG_KONZEPT.md` erstellen
4. `docs/ADMIN_BERECHTIGUNGEN_KONZEPT.md` erstellen

---

## LOG-056 - Monday Board Column Mapping: 338 Spalten dokumentiert

**Datum:** 2026-02-01
**Status:** Abgeschlossen

### Aufgabe

Vollstaendiges Mapping aller Monday.com Board-Spalten (Board ID: 1545426536) erstellen und dokumentieren.

### Ergebnis

**Statistiken:**
| Metrik | Wert |
|--------|------|
| Monday-Spalten Total | 338 |
| Supabase-Spalten Total | 97 |
| Gemappte Spalten | ~45 |
| Bidirektionale Spalten | 4 |

**Erstellte Dateien:**
1. `docs/MONDAY_COLUMN_MAPPING.md` - Vollstaendige Dokumentation
2. `docs/monday_column_mapping.json` - Maschinenlesbares Mapping

**Monday Spalten-Typen:**
- text: 46
- status/color: 71
- date: 46
- numeric: 35
- link: 26
- formula: 26
- file: 5
- button: 13
- andere: 70

**Wichtige Mappings:**
| Monday ID | Supabase | Typ |
|-----------|----------|-----|
| `text49__1` | `atbs_nummer` | text |
| `status06__1` | `status_projekt` | status |
| `text_mkm11jca` | `auftraggeber` | text |
| `zahlen1__1` | `budget` | numeric |
| `datum2__1` | `baustart` | date |
| `datum7__1` | `bauende` | date |
| `link__1` | `hero_link` | link |

**Migration ausgefuehrt:**
- `monday_column_flattening_sync_v2`: Alle 197 Projekte mit column_values Daten in echte Spalten geflattent
- 100% atbs_nummer, status_projekt, auftraggeber befuellt
- 97% budget, 90% baustart befuellt

### Strategie (D039)

Nur wichtige Spalten werden als echte Supabase-Spalten synchronisiert. Der Rest bleibt im `column_values` JSONB-Feld verfuegbar.

---

## LOG-055 - Telegram-Bot v71: Phasen-Bug-Fix + monday_bauprozess Flattening

**Datum:** 2026-02-01 09:30
**Status:** Abgeschlossen

### Problem

Telegram-Bot zeigte "Keine Projekte gefunden" bei allen Phasen-Auswahlen.

### Ursache

1. **Falsches Feld:** `extractPhase()` las `dropdown0__1` statt `status06__1`
2. **Falsche Labels:** PHASE_LABELS stimmten nicht mit Monday √ºberein
3. **Echte Phasen:** "(0) Bedarfsanalyse", "(1) Angebotsphase", etc. (nicht "Offen", "Geplant")

### L√∂sung: monday_bauprozess Flattening

**Migration `monday_bauprozess_flatten_columns`:**
14 neue echte Spalten statt nur JSONB:
- `atbs_nummer`, `status_projekt`, `auftraggeber`, `adresse`
- `bauleiter`, `bauleiter_email`, `bauleiter_telefon`
- `nachunternehmer`, `budget`, `baustart`, `bauende`
- `hero_projekt_id`, `sharepoint_link`, `matterport_link`

**Migration `monday_bauprozess_sync_source`:**
Bidirektionaler Sync Support:
- `sync_source` ('monday'|'supabase'|'pending'|'synced')
- `last_supabase_change_at`, `last_monday_push_at`, `push_error_count`

### Code-√Ñnderungen (telegram-webhook v71)

- `extractPhase()` ‚Üí Direkt `projekt.status_projekt`
- `listProjekteByPhase()` ‚Üí DB-Filter mit `LIKE` statt JS-Filter
- `openProjekt()` ‚Üí Nutzt echte Spalten statt column_values
- Queries selektieren echte Spalten, nicht mehr column_values JSONB

### Ergebnis

| Vorher | Nachher |
|--------|---------|
| 0 Projekte gefunden | 5 Projekte in Phase 0 |
| JS-Filter auf 200 Rows | DB-Filter direkt |
| `column_values->'status06__1'->>'text'` | `status_projekt` |

### Offene Punkte

- monday-sync noch nicht angepasst (bef√ºllt neue Spalten noch nicht automatisch)
- 338 Monday-Spalten insgesamt, nur 14 wichtigste als echte Spalten

---

## LOG-053 - CPQ-Test + UI-Verbesserungen dokumentiert

**Datum:** 2026-02-01 00:00
**Status:** Abgeschlossen

### Durchgef√ºhrt

- CPQ-Workflow getestet nach Bugfixes der vorherigen Session
- KI-Erkennung funktioniert gut
- **3 Verbesserungsw√ºnsche vom User dokumentiert:**

### Gew√ºnschte Verbesserungen

1. **GWS-LV Priorisierung:**
   - Vorschl√§ge zuerst aus GWS-LV
   - Dropdown f√ºr andere LVs (VBW, neurealis, etc.)

2. **Freitextsuche:**
   - Volltextsuche √ºber alle 3.167 LV-Positionen
   - Unterhalb der KI-Vorschl√§ge anzeigen

3. **Mehrfachauswahl pro Leistung:**
   - Zu einer erkannten Leistung mehrere LV-Artikel hinzuf√ºgen
   - Nicht nur 1:1 Mapping

### N√§chste Schritte

- ‚úÖ Alle Verbesserungen in LOG-054 implementiert

---

## LOG-054 - CPQ-Verbesserungen: 7 Features implementiert (T1-T4)

**Datum:** 2026-01-31
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Implementierte Features

| # | Feature | Status |
|---|---------|--------|
| 1 | LV-Priorisierung | ‚úÖ Priority-LV aus Request |
| 2 | Freitextsuche | ‚úÖ Hybrid: pg_trgm + Embedding Fallback |
| 3 | Preisanzeige | ‚úÖ Nur VK-Preis (listenpreis) |
| 4 | Sortierung | ‚úÖ Similarity DESC, dann Preis DESC |
| 5 | Mehrfachauswahl | ‚úÖ "+" Button neben Vorschl√§gen |
| 6 | LV-Filter | ‚úÖ Initial auf ausgew√§hltes LV |
| 7 | Lern-System | ‚úÖ Hierarchisch (LV-spezifisch ‚Üí global) |

### Subagenten

| Agent | Aufgabe | Ergebnis |
|-------|---------|----------|
| T1 | Backend: transcription-parse v5 | ‚úÖ Hierarchisches Lern-System |
| T2 | SQL: RPCs f√ºr Hybrid-Suche | ‚úÖ pg_trgm + 2 neue RPCs |
| T3 | UI: Frontend-√Ñnderungen | ‚úÖ listenpreis, "+"-Button, Sortierung |
| T4 | QA: Code-Review + Tests | ‚úÖ 12/12 Checks, 0 Fehler |

### Technische √Ñnderungen

**Migration `20260131213758_cpq_hybrid_search`:**
- `pg_trgm` Extension aktiviert
- GIN-Indizes auf `bezeichnung` und `beschreibung`
- `search_lv_positions_hybrid()` RPC (Fuzzy ‚Üí Embedding)
- `search_position_corrections_hierarchical()` RPC (LV ‚Üí global)

**Edge Function transcription-parse v5:**
- Priority-LV aus Request-Body
- Hierarchisches Lern-System mit `is_global_match` Flag
- Bei globalem Treffer: Bezeichnung als Hinweis, Suche im aktuellen LV

**UI-√Ñnderungen:**
- `listenpreis` (VK) statt `einzelpreis` (EK)
- "+" Button f√ºr Mehrfachauswahl pro Position
- Sortierung: Similarity DESC, bei gleich Preis DESC

### Deployments

- Edge Function: `transcription-parse` v5 ‚Üí Supabase v9
- UI: https://neurealis-erp.netlify.app (76 Assets, 50 neu)

### QA-Ergebnis

- 12/12 Checks bestanden
- 4 Warnungen (nicht kritisch):
  - W1: Umlaut in Kommentar (gefixt)
  - W2: position_corrections leer (normal)
  - W3: 31% LV ohne listenpreis (Fallback vorhanden)
  - W4: A11y-Warnungen (optional)

---

## LOG-052 - CPQ-Workflow Fix: Fehlerbehandlung + transcription-parse v7

**Datum:** 2026-01-31 ~23:45
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Probleme behoben

**1. UI-Fehlerbehandlung "is not a true Error":**
- **Problem:** `supabase.functions.invoke()` gibt bei Fehlern `FunctionsHttpError` zur√ºck, nicht `Error`
- **Ursache:** `err instanceof Error` Pr√ºfung schlug fehl
- **L√∂sung:** Neue `getErrorMessage()` Utility-Funktion f√ºr robuste Fehlerbehandlung
- **Datei:** `ui/src/routes/angebote/neu/+page.svelte`

**2. transcription-parse 400-Fehler:**
- **Problem:** GPT-5.2 API gab 400 zur√ºck
- **Ursache:** `max_tokens` Parameter nicht unterst√ºtzt bei GPT-5.2
- **L√∂sung:** `max_completion_tokens: 4000` statt `max_tokens: 4000`
- **Deployed:** transcription-parse v7

### Verifizierung

Test-Request erfolgreich:
- Input: "Bad fliesen 12 qm und 3 Steckdosen neu"
- Output: 2 Positionen mit LV-Matches und Alternativen
- Statistik: 2 total, 2 mit_match, 0 ohne_match

### Subagenten eingesetzt

| Agent | Aufgabe | Ergebnis |
|-------|---------|----------|
| T1 | UI-Fehlerbehandlung | ‚úÖ getErrorMessage() implementiert |
| T2 | RPC-Funktionen pr√ºfen | ‚úÖ Alle 3 vorhanden |
| T3 | DB-Tabellen pr√ºfen | ‚úÖ Alle 6 CPQ-Tabellen vorhanden |

### Learnings

- **L137:** GPT-5.2 ben√∂tigt `max_completion_tokens` statt `max_tokens` (best√§tigt L028)
- **L138:** Supabase FunctionsHttpError ist kein echtes Error-Objekt

---

## LOG-051 - WordPress-Sync IONOS-Fix + Blog-Optimierung (T1-T13)

**Datum:** 2026-01-31 ~19:00 - 23:00
**Dauer:** ~4 Stunden
**Status:** Abgeschlossen (3 Subagenten noch aktiv)

### Haupterfolg: IONOS Auth-Problem gel√∂st

**Problem:** IONOS Hosting strippt HTTP Authorization Header im CGI-Modus
**L√∂sung:** 3-stufiger Workaround:
1. JWT Authentication Plugin installiert
2. `JWT_AUTH_SECRET_KEY` in wp-config.php gesetzt
3. Custom Header `X-WP-Auth` statt `Authorization` verwenden
4. wp-config.php liest X-WP-Auth und kopiert nach HTTP_AUTHORIZATION

**Ergebnis:** 8 Blog-Artikel erfolgreich nach WordPress ver√∂ffentlicht!

### Blog-Optimierung mit 13 Subagenten-Tasks

| Task | Beschreibung | Status |
|------|--------------|--------|
| T1 | Leerstand-Artikel √ºberarbeiten | ‚úÖ 2.100 W√∂rter |
| T2 | WordPress-Struktur analysieren | ‚úÖ 82 Posts/Pages |
| T3 | Eigenheim-Template erstellen | ‚úÖ 2.350 W√∂rter |
| T4 | WordPress ‚Üí GitHub Backup | ‚úÖ 1,3 MB |
| T5 | SEO-L√ºcken schlie√üen | ‚úÖ Tags, Kategorien, Images |
| T6 | Eigenheim Kostenkorrektur | ‚úÖ 121.000 EUR |
| T7 | Upload mit Layout | ‚úÖ 2 Artikel |
| T8 | Alle KI-Artikel verbessern | ‚úÖ 7 Artikel |
| T9 | Broken Links fixen | ‚úÖ 23 Ersetzungen |
| T10 | WordPress API Schema | ‚úÖ 485 Routen |
| T11 | T8-Artikel hochladen | üîÑ L√§uft |
| T12 | Elementor API testen | üîÑ L√§uft |
| T13 | Eigenheim-Seite Elementor+Yoast | üîÑ L√§uft |

### Neue Learnings

- L085: IONOS X-WP-Auth Workaround f√ºr JWT
- L086: WordPress API Discovery (485 Routen, 22 Namespaces)
- L087: Elementor speichert Layouts in _elementor_data Post-Meta
- L088: Yoast SEO Meta via _yoast_wpseo_* Post-Meta setzen
- L089: Subagenten-Koordination √ºber Tracker-Dateien

---

## LOG-050 - T10: WordPress REST API Discovery

**Datum:** 2026-01-31
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Vollstaendige Analyse der WordPress REST API auf neurealis.de durchgefuehrt. 485 Routen in 22 Namespaces dokumentiert.

### Durchgefuehrte Arbeiten

**API-Analyse:**
- Haupt-API-Index abgerufen
- Alle 22 Namespaces identifiziert
- 485 Routen dokumentiert
- Schwerpunkte: Elementor (79 Routen), wp/v2 (132 Routen), Yoast (45 Routen)

**Dokumentation erstellt:**
- `docs/wordpress_api/README.md` - Uebersicht
- `docs/wordpress_api/core.md` - Posts, Pages, Media
- `docs/wordpress_api/elementor.md` - Page Builder
- `docs/wordpress_api/yoast.md` - SEO-Metadaten
- `docs/wordpress_api/jwt_auth.md` - Authentifizierung
- `docs/wordpress_api/plugins.md` - Redirection, Frase, WPVR

### Wichtige Erkenntnisse

1. **Elementor:** 79 API-Routen, aber Content als JSON in Post-Meta (komplex)
2. **Yoast:** SEO-Daten als `yoast_head_json` im Post (read-only), setzen via Post-Meta
3. **JWT Auth:** Funktioniert, aber IONOS-Problem bleibt (L083-L084)
4. **Kategorien:** 5 vorhanden (Allgemein, Regional, Sanierungsarten, Vermieter-Wissen)

### Ergebnis

Vollstaendige API-Dokumentation unter `docs/wordpress_api/` erstellt.
Hauptreport: `docs/implementation/t10_api_discovery.md`

---

## LOG-049 - T9: Broken Links finden und fixen

**Datum:** 2026-01-31
**Dauer:** ~20 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Broken Links auf neurealis.de identifiziert und automatisch gefixt. 107 Links gescannt, 12 broken gefunden, 23 Ersetzungen durchgef√ºhrt.

### Durchgef√ºhrte Arbeiten

**Analyse:**
- Alle Posts (11) und Pages (71) von WordPress REST API geholt
- Links aus Content extrahiert (86 intern, 21 extern)
- Jeden Link mit HEAD-Request gepr√ºft
- 10 interne + 2 externe broken links gefunden

**Fixes (11 Posts/Pages erfolgreich aktualisiert):**
- KI-generierte Blog-Links (`/blog/...`) zu echten Artikeln umgeleitet
- Alte Leistungen-Seite zu Aufwertung-Seite umgeleitet
- Tippfehler bei Datenschutz und Sanierungs-Beispiele korrigiert

**Ursachen der Broken Links:**
1. KI-Halluzinationen: `/blog/` URLs die nie existierten
2. Umbenannte Seiten ohne Redirects
3. Tippfehler in URLs

### Erstellte Scripts

- `scripts/broken-link-checker.mjs` - Findet alle broken links
- `scripts/fix-broken-links.mjs` - Fixt interne broken links via WordPress API

### Offene externe Links

- `{{ unsubscribe_link }}` - Newsletter-Platzhalter auf Testseite
- `http://Prozess` - Tippfehler auf Karriere-Seite

### Reports

- `docs/implementation/t9_broken_links.md` - Detaillierter Report
- `docs/implementation/broken_links_report.json` - Rohdaten

---

## LOG-050 - CPQ-Bugfixes: Projektauswahl, transcription-parse v3, Umlaute

**Datum:** 2026-01-31 ~02:30
**Dauer:** ~30 Minuten (3 parallele Subagenten)
**Status:** Abgeschlossen

### Zusammenfassung

Drei kritische Bugs im CPQ-System behoben: Projektauswahl zeigte "[object Object]", Edge Function gab Fehler, Umlaute wurden als ae/oe/ue angezeigt.

### Durchgef√ºhrte Arbeiten

**1. Projektauswahl-Fix:**
- Problem: Dropdown zeigte "Object" statt Projektnamen
- Ursache: JSONB-Struktur `column_values?.status__1` ist verschachtelt `{text: "...", value: null}`
- Fix: Korrektes Parsing mit `column_values?.status__1?.text`
- Phase-Extraktion per Regex `\((\d+)\)` aus "(0) Offen"

**2. transcription-parse v3:**
- Problem: Status 400 wegen inkonsistentem Response-Format
- Fix: Prompt und `response_format` konsistent gemacht (beide erwarten `{"positionen": [...]}`)
- TypeScript Error-Handling verbessert (`error instanceof Error` Check)
- Version auf v3 deployed

**3. Umlaute-Korrektur (18 Dateien, ~100 Fixes):**
- UI-Dateien: angebote, bauvorhaben, kontakte, einkauf, etc.
- Edge Functions: email-process, email-fetch, search-lv, nachtrag-action
- Beispiele: "pruefen" ‚Üí "pr√ºfen", "fuer" ‚Üí "f√ºr", "Uebersicht" ‚Üí "√úbersicht"

**4. CLAUDE.md aktualisiert (v2.4):**
- Umlaut-Box erweitert mit allen Anwendungsbereichen
- In VERBOTEN-Tabelle aufgenommen als harte Anforderung

### Ge√§nderte Dateien

**UI (17 Dateien):**
- `angebote/neu/+page.svelte` (Projektauswahl + 23 Umlaute)
- `bauvorhaben/[id]/+page.svelte` (21 Umlaute)
- `kontakte/+page.svelte` (18 Umlaute)
- + 14 weitere Komponenten

**Edge Functions:**
- `transcription-parse/index.ts` (v3)
- 4 weitere Functions (Umlaute)

**Dokumentation:**
- `C:\Users\holge\CLAUDE.md` (v2.4)

---

## LOG-048 - T5: SEO-L√ºcken schlie√üen

**Datum:** 2026-01-31
**Dauer:** ~15 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

SEO-Optimierung der 8 KI-generierten Blog-Artikel √ºber WordPress REST API: Tags, Kategorien und Featured Images zugewiesen.

### Durchgef√ºhrte Arbeiten

**L√ºcke 1: Tags erstellen und zuweisen:**
- 14 neue Tags erstellt: Kernsanierung, Komplettsanierung, Badsanierung, Bochum, Ruhrgebiet, NRW, Kosten, F√∂rderung, KfW, Vermieter, Mietwohnung, Leerstand, GEG, Sanierungspflicht
- Alle 8 KI-Artikel mit passenden Tags (3-5 pro Artikel) versehen

**L√ºcke 2: Kategorien erweitern:**
- 3 neue Kategorien erstellt: Vermieter-Wissen, Regional, Sanierungsarten
- Alle 8 Artikel in passende Kategorien eingeordnet

**L√ºcke 3: Featured Images:**
- Alle 8 Artikel hatten featured_media: 0
- Bild ID 12028 (qohnzimmer-quer.webp) als Featured Image gesetzt
- Empfehlung: Themenspezifische Bilder hochladen

**L√ºcke 4: Interne Verlinkung:**
- 10 Empfehlungen dokumentiert (Blog ‚Üí Landing Pages, Blog ‚Üí Blog)
- Erfordert manuelle Content-Updates

### Technisch

- WordPress REST API mit JWT-Auth (X-WP-Auth Header)
- Script: `scripts/seo-fix.mjs`
- Report: `docs/implementation/t5_seo_fixes.md`

### Neue IDs in WordPress

| Typ | ID-Range |
|-----|----------|
| Tags | 195-208 |
| Kategorien | 209-211 |

---

## LOG-047 - Angebots-CPQ Vollst√§ndig: UI-Wizard + Drag&Drop + Lern-System

**Datum:** 2026-01-31 ~01:30
**Dauer:** ~2 Stunden (6 parallele Subagenten)
**Status:** Abgeschlossen

### Zusammenfassung

Vollst√§ndige Implementierung des Angebots-CPQ Systems mit 8-Schritt UI-Wizard, Drag&Drop Komponenten, Lern-System f√ºr KI-Korrekturen und 44 Angebotsbausteinen.

### Durchgef√ºhrte Arbeiten (6 Tasks parallel)

**T1: DB-Schema (lv_config, angebots_bausteine, position_corrections):**
- `lv_config`: 3 LV-Typen mit Gewerken (GWS: 46, VBW: 23, neurealis: 35)
- `angebots_bausteine`: Vorlagen-Tabelle
- `position_corrections`: Lern-System mit Vector-Index
- RPC: `search_position_corrections()`
- RLS Policies f√ºr alle Tabellen

**T2: transcription-parse v2:**
- Hybrid-Prompt mit LV-Parametern aus `lv_config`
- Fallback-Suche √ºber alle LVs wenn Haupt-LV keine Treffer
- Korrektur-System: Gelernte Mappings anwenden (Threshold 0.92)
- Top 5 Alternativen pro Position zur√ºckgeben
- Statistiken (Matches, Fallbacks, Korrekturen)

**T3: UI-Wizard (/angebote/neu):**
- 8-Schritt Wizard: Projekt ‚Üí Eingabe ‚Üí Positionen pr√ºfen ‚Üí Gruppen ‚Üí Abh√§ngigkeiten ‚Üí Aufma√ü ‚Üí Preise ‚Üí Freigabe
- 3-Spalten Layout f√ºr Position-Korrektur (Original | Erkannt | Alternativen)
- Korrekturen werden f√ºr Lern-System gespeichert
- Sidebar-Link hinzugef√ºgt

**T4: Drag&Drop Komponenten:**
- `DraggableList.svelte` - Native HTML5 Drag&Drop
- `PositionItem.svelte` - Inline-Edit f√ºr Mengen
- `PositionGroup.svelte` - Collapsible mit Kopieren/L√∂schen
- `PositionGroupList.svelte` - Container mit Toolbar
- Touch-Support f√ºr Mobile

**T5: Angebotsbausteine (44 Eintr√§ge):**
- 3 Angebotsannahme-Vorlagen (HTML mit Unterschriftsfelder)
- 2 NUA-Vertragswerke (¬ß1-¬ß12 VOB/B)
- 10 Textbausteine (Zahlungsbedingungen, Gew√§hrleistung, etc.)
- 29 Bedarfspositionen mit echten GWS-Listenpreisen

**T6: Qualit√§tssicherung:**
- TypeScript-Fehler behoben (Type-Exports aus Svelte)
- Build erfolgreich (18.62s)
- Alle 7 Pr√ºfpunkte bestanden

### Neue Dateien

```
ui/src/routes/angebote/+page.svelte
ui/src/routes/angebote/neu/+page.svelte
ui/src/routes/api/position-correction/+server.ts
ui/src/lib/components/cpq/DraggableList.svelte
ui/src/lib/components/cpq/PositionItem.svelte
ui/src/lib/components/cpq/PositionGroup.svelte
ui/src/lib/components/cpq/PositionGroupList.svelte
ui/src/lib/components/cpq/types.ts
ui/src/lib/components/cpq/index.ts
```

### Offene TODOs (Phase 2)

1. PDF-Generierung (jsPDF Integration)
2. Modal f√ºr manuelle Position hinzuf√ºgen
3. NUA-Detection implementieren
4. Raum-Struktur als Alternative
5. Auto-Save/Draft-Speicherung

### Learnings

- **L109:** Svelte 5 Type-Exports m√ºssen in separater types.ts Datei sein, nicht in .svelte Komponenten
- **L110:** 6 parallele Subagenten f√ºr gro√üe Features extrem effektiv - Kontext-Window bleibt sauber

---

## LOG-046 - Angebots-CPQ Backend: DB-Migration + LV-Abh√§ngigkeiten + transcription-parse

**Datum:** 2026-01-30 ~22:30
**Dauer:** ~2 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Backend-Infrastruktur f√ºr Angebots-CPQ System implementiert: DB-Tabellen, LV-Abh√§ngigkeiten analysiert und gespeichert, Edge Functions deployed.

### Durchgef√ºhrte Arbeiten

**1. T1: DB-Migration (6 Tabellen):**
- `pricing_profiles` - 6 Profile (GWS, VBW, Covivio, neurealis, Privataufschlag 15%/20%)
- `kunde_pricing` - Kundenspezifische Aufschl√§ge
- `position_dependencies` - LV-Abh√§ngigkeiten
- `angebote` - Haupttabelle mit Status-Workflow
- `angebots_positionen` - Positionsdetails erweitert
- `dokument_sequenzen` + `get_next_dokument_nr()` RPC

**2. T3: LV-Abh√§ngigkeiten-Analyse (lokal via Subagenten):**
| LV-Typ | Positionen | Abh√§ngigkeiten |
|--------|------------|----------------|
| GWS | 561 | 74 |
| VBW | 100 | 39 |
| neurealis | 236 | 25 |
| **TOTAL** | 897 | **138** |

Typen: `referenced_in_text`, `often_together`, `required`, `suggested`

**3. T4: transcription-parse Edge Function:**
- Deployed (Version 1)
- GPT-5.2 Extraktion + Embedding-basierte LV-Suche
- Abh√§ngigkeiten aus DB laden

**4. LV-Prompt-Analyse:**
- Gewerke-Namen sind pro LV komplett unterschiedlich
- Empfehlung: Hybrid-Ansatz (Ein Template + LV-spezifische Parameter)
- Neue Tabelle `lv_config` vorgeschlagen

### Probleme & L√∂sungen

**Problem:** Edge Function `analyze-lv-dependencies` hatte Timeout (>150s)
**L√∂sung:** Lokale Analyse via Subagenten ohne Timeout-Limit

### Erstellte Dateien

```
docs/implementation/
‚îú‚îÄ‚îÄ T1_MIGRATION_RESULT.md
‚îú‚îÄ‚îÄ T3_GWS_RESULT.md / T3_GWS_LOKAL.md
‚îú‚îÄ‚îÄ T3_VBW_RESULT.md / T3_VBW_LOKAL.md
‚îú‚îÄ‚îÄ T3_NEUREALIS_RESULT.md / T3_NEUREALIS_LOKAL.md
‚îú‚îÄ‚îÄ T4_TRANSCRIPTION_RESULT.md
‚îî‚îÄ‚îÄ LV_PROMPT_ANALYSE.md
```

### N√§chste Schritte

1. `lv_config` Tabelle + Hybrid-Prompt implementieren
2. UI-Wizard f√ºr Angebotserstellung
3. PDF-Generierung anpassen

---

## LOG-044 - Hero LV-Bereinigung: Duplikate, Alt-Versionen, Artikelnummern

**Datum:** 2026-01-31 ~04:00
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Umfassende Bereinigung der Hero LV-Positionen: Duplikate gel√∂scht, Alt-Versionen archiviert, generische Artikelnummern durch Schema ersetzt.

### Durchgef√ºhrte Arbeiten

**1. Supabase - Duplikat zusammengef√ºhrt:**
- `GWS.LV23-01.01.24` (115,87 ‚Ç¨) behalten
- `LV23-01.01.24` (100,00 ‚Ç¨) gel√∂scht
- Preis-Historie eingef√ºgt (100 ‚Ç¨ ‚Üí 115,87 ‚Ç¨)

**2. Hero - DUPLIKAT und ALT gel√∂scht:**
| Typ | Anzahl |
|-----|--------|
| DUPLIKAT-* | 190 |
| ALT-* | 436 |
| **Summe** | **626** |

**3. Hero - Doppelte Artikelnummern bereinigt:**
- 195 Positionen mit niedrigerem Preis gel√∂scht
- H√∂herer Preis jeweils behalten

**4. Hero - Generische Artikelnummern ersetzt:**
| Alt | Neu |
|-----|-----|
| (LEER) | Sanitaer-Dusche-Zulage |
| (LEER) | Allgemein-Anfahrt-Pauschale |
| freie Position | Boden-Platten-Rueckbau |
| 0 | Allgemein-Leer-Position |
| rei | Sanitaer-Silikon-Erneuerung |
| frei | Elektrik-Sat-Anschluss |
| Trenner | Trenner-Maurer-Linie |

**5. Ignorierte Konflikte (manuelle Korrektur n√∂tig):**
- FC.LV25.8.x Forte Capital (6 vertauschte Nummern)
- GWS.LV23-21.02.01.34 (Stand-WC vs Wand-WC)

### Backups erstellt

- `docs/backups/2026-01-31_hero_duplikat_alt_backup.json`
- `docs/backups/2026-01-31_hero_duplikate_niedriger_preis.json`
- `docs/backups/2026-01-31_hero_artikelnummern_neu.json`

### Gesamtergebnis

| Aktion | Anzahl |
|--------|--------|
| DUPLIKAT-* gel√∂scht | 190 |
| ALT-* gel√∂scht | 436 |
| Niedrigere Preise gel√∂scht | 195 |
| Generische Nr. ersetzt | 7 |
| **Total bereinigt** | **828** |

### Neue Learnings

- L098: Hero GraphQL Soft-Delete via `is_deleted: true`
- L099: Artikelnummer-Schema: Gewerk-Bauteil-Aspekt (Title Case)
- L100: Bei LV-Duplikaten immer h√∂heren Preis behalten

---

## LOG-045 - Angebots-CPQ Konzept: Transkription‚ÜíAngebot Tool + Aufma√ü-Geometrien

**Datum:** 2026-01-30 ~17:00 - 18:00
**Dauer:** ~2,5 Stunden
**Status:** Konzept fertig

### Zusammenfassung

Vollst√§ndiges Konzept f√ºr ein CPQ-System (Configure-Price-Quote) entwickelt, das aus Spracheingaben, Transkriptionen und Katalogsuche automatisch strukturierte Angebote generiert. Basiert auf ChatGPT-Vorarbeit, angepasst an bestehende neurealis-Infrastruktur. Nachtr√§glich um Raumgeometrien (L-Form, U-Form) und CSV-Import im Wizard erweitert.

### Durchgef√ºhrte Arbeiten

**1. Bestehende Infrastruktur analysiert (3 Subagenten parallel)**
- `aufmass_data` Tabelle: rooms JSONB mit Raumfl√§chen
- `lv_positionen`: 3.167 Positionen mit Embeddings (pgvector)
- `process-aufmass-complete`: CSV‚ÜíExcel Edge Function
- PDF-Generator: jsPDF + autotable in lv-export

**2. Konzept erstellt**
- 6-Schritt-Wizard: Projekt ‚Üí Positionen ‚Üí Mengen ‚Üí Kalkulation ‚Üí Freigabe ‚Üí Versand
- Nummernlogik: ATBS-472-ANG01, -AB01, -NUA01, -RE01
- Abh√§ngigkeiten-System: LV-Langtext-Analyse + Admin-Regeln + Kundenspezifisch
- Pricing-Profile: Basis-LV + Aufschl√§ge pro Kundengruppe

**3. Technische Dokumentation erstellt**
- SQL-Migrationen (6 neue Tabellen)
- Edge Function Specs (transcription-parse, analyze-lv-dependencies)
- UI-Route-Struktur (SvelteKit)
- Seed-Daten f√ºr Abh√§ngigkeiten

**4. Nachtr√§gliche Erweiterungen (User-Feedback)**
- CSV-Import direkt im Wizard-Dialog (nicht nur via Telegram)
- Raumgeometrien: Rechteck, L-Form, U-Form als Dropdown
- Teilfl√§chen-Eingabe f√ºr komplexe R√§ume (A, B, C)
- Gemeinsame W√§nde (Innenw√§nde zwischen Teilfl√§chen)
- Abz√ºge (T√ºren, Fenster) von Wandfl√§che
- Berechnungslogik f√ºr alle Geometrien dokumentiert

### Dateien erstellt/aktualisiert

- `docs/ANGEBOTS_CPQ_KONZEPT.md` (Konzept + UI-Mockups + Geometrien)
- `docs/implementation/ANGEBOTS_CPQ_IMPLEMENTATION.md` (SQL + TypeScript + Berechnungen)

### Schl√ºsselentscheidungen

1. **MVP nach Gewerken** (nicht R√§umen) - einfacher
2. **Abh√§ngigkeiten aus LV-Langtexten** via KI-Analyse
3. **Regelbasiert zuerst** - ML-Lernen in Phase 3
4. **Bestehende PDF-Generierung nutzen** (jsPDF aus LV-Export)
5. **Aufma√ü via CSV** (nicht Matterport API) - bereits funktioniert
6. **Raumgeometrien:** Rechteck, L-Form, U-Form mit Teilfl√§chen

### Neue Learnings

- L109-L114: CPQ-Wizard, Abh√§ngigkeiten, Aufma√ü-UI, Nummernlogik, Pricing, Geometrien

### Offene Punkte (User-Feedback n√∂tig)

1. ~~Aufma√ü-Geometrie~~ ‚Üí Gel√∂st: Rechteck, L-Form, U-Form
2. Annahme-Formular: Text f√ºr letzte Seite?
3. NUA-Vertragswerk: Kleingedruckter Text?
4. Standard-Bedarfspositionen: Liste?

### N√§chste Schritte

1. DB-Migration ausf√ºhren
2. LV-Langtext-Analyse f√ºr GWS starten
3. Wizard-UI bauen

---

## LOG-043 - Angebot aus Baubesprechungs-Transkription (ATBS-472)

**Datum:** 2026-01-31 ~03:30
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Automatische Angebotserstellung aus Baubesprechungs-Transkription (Plaud-Aufnahme). Leistungen aus Sprachaufnahme extrahiert, GWS-LV-Positionen zugeordnet, und strukturiertes HTML-Angebot mit korrekten Listenpreisen erstellt.

### Durchgef√ºhrte Arbeiten

**1. Transkription analysiert (ATBS-472, GWS Bollwerkstra√üe 9)**
- Baubesprechung mit Herrn Fromme (GWS), Mieter Minner, 4. OG
- 45 Minuten Aufnahme ‚Üí Leistungspositionen extrahiert
- 9 Gewerke identifiziert: Demontage, Boden, Sanit√§r, Heizung, Elektro, Maler, Tischler, Reinigung, Sonstiges

**2. GWS-LV-Positionen zugeordnet**
- 41 Einzelpositionen mit Artikelnummern
- Subagent f√ºr parallele DB-Abfragen genutzt
- Mengen aus Transkription gesch√§tzt (ca. 60m¬≤ Wohnung)

**3. Preiskorrektur: EK ‚Üí Listenpreis**
- **Problem erkannt:** Erste Version nutzte `preis` (EK) statt `listenpreis` (VK)
- DB-Struktur: `preis` = Einkaufspreis, `listenpreis` = Verkaufspreis f√ºr GWS
- **Korrigiert:** Alle Positionen auf Listenpreise umgestellt
- **Differenz:** 10.230,51 ‚Ç¨ (EK) ‚Üí 14.427,46 ‚Ç¨ (VK) = **+41%**

**4. HTML-Angebot erstellt**
- Druckbares HTML mit neurealis-Branding
- "Als PDF drucken" Button integriert
- Alle Gewerke mit Zwischensummen
- Gesamt√ºbersicht mit Netto/Brutto

### Ergebnis

**Angebot ANG-ATBS-472:**
| | Betrag |
|--|------:|
| Netto | 14.427,46 ‚Ç¨ |
| Brutto | 17.168,68 ‚Ç¨ |

**Gr√∂√üte Gewerke:**
- Boden: 3.806,18 ‚Ç¨ (26%)
- Maler: 3.487,75 ‚Ç¨ (24%)
- Elektro: 2.069,15 ‚Ç¨ (14%)
- Sanit√§r: 1.680,34 ‚Ç¨ (12%)

### Dateien erstellt

- `docs/angebote/ATBS-472_angebot.md` (Markdown)
- `docs/angebote/ANG-ATBS-472_Bollwerkstr9_GWS.html` (druckbares HTML)
- `docs/angebote/export-atbs-472-pdf.mjs` (PDF-Export-Script)

### Learnings

- **L103:** `preis` = EK, `listenpreis` = VK in lv_positionen
- **L104:** Transkription ‚Üí Angebot Workflow etabliert

---

## LOG-042 - Nachtrag-Bug-Fix + gemeldet_von + LV-Konsolidierung

**Datum:** 2026-01-31 ~01:00
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Bug-Fix f√ºr Telegram-Bot Nachtrag-Erstellung (CHECK constraint Fehler), dynamische gemeldet_von Erkennung implementiert, Embedding-basierte LV-Position-Suche aktiviert, und LV-Typ "Privat" in "neurealis" konsolidiert.

### Durchgef√ºhrte Arbeiten

**1. Bug-Fix: Nachtrag speichern scheiterte**
- **Problem:** "Fehler beim Speichern" nach Nachtrag-Analyse im Telegram-Bot
- **Ursache:** CHECK constraints verletzt:
  - `nachtraege_status_check`: Code nutzte `'Gemeldet'` (ung√ºltig)
  - `nachtraege_gemeldet_von_check`: Code nutzte `'telegram'` (ung√ºltig)
- **Fix v56:** Status auf `'(0) Offen / Preis eingeben'` ge√§ndert
- **Migration:** `'telegram'` zu gemeldet_von CHECK constraint hinzugef√ºgt

**2. Dynamische gemeldet_von Erkennung (v57)**
- Lookup: `telegram_chat_id` in kontakte-Tabelle
- Rolle `NU` (Nachunternehmer) ‚Üí `gemeldet_von='nu'`
- Rolle `BL` oder Name "Holger Neumann" ‚Üí `gemeldet_von='bauleiter'`
- Fallback: `gemeldet_von='telegram'`

**3. Embedding-basierte LV-Position-Suche (v58)**
- Nachtrag-Text ‚Üí Embedding ‚Üí `search_lv_positions` RPC
- Similarity-Threshold: 0.6 (60%)
- Positionen nur angezeigt wenn gefunden
- Telegram-Ausgabe formatiert mit Preis und Similarity%

**4. Verbesserte Embeddings (lv-embed-regenerate)**
- Kombination: `bezeichnung + ' - ' + strip_html(beschreibung)`
- Neue Spalte: `embedding_text` f√ºr Nachvollziehbarkeit
- Alle 2.214 LV-Positionen regeneriert

**5. LV-Typ Konsolidierung**
- "Privat" ‚Üí "neurealis" umbenannt (281 Positionen)
- neurealis hat jetzt 693 Positionen (vorher 412)
- Backup: `docs/backups/2026-01-30_lv_positionen_privat_to_neurealis.json`

### Edge Functions deployed

| Function | Version | √Ñnderung |
|----------|---------|----------|
| telegram-webhook | v58 | Embedding-LV-Suche, gemeldet_von dynamisch |
| lv-embed-regenerate | v1 | Kombinierte Embeddings (bezeichnung + beschreibung) |

### Neue Learnings

- L101: CHECK constraints bei Telegram-Bot Inserts beachten
- L102: LV-Typen konsolidieren statt doppelt pflegen

---

## LOG-041 - Telegram-Bot v58 - Embedding-basierte LV-Suche + lv-embed-regenerate

**Datum:** 2026-01-31 ~00:00
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Erweiterung des Telegram-Bots um Embedding-basierte LV-Position-Suche f√ºr Nachtr√§ge. Die bisherige Score-basierte Suche wurde durch semantische √Ñhnlichkeitssuche via pgvector ersetzt. Zus√§tzlich wurde eine Edge Function `lv-embed-regenerate` erstellt, die die Embeddings mit kombiniertem Text (bezeichnung + strip_html(beschreibung)) regeneriert.

### Durchgef√ºhrte Arbeiten

**1. Migration: embedding_text Spalte + strip_html Funktion**
```sql
ALTER TABLE lv_positionen ADD COLUMN embedding_text TEXT;

CREATE OR REPLACE FUNCTION strip_html(text) RETURNS text AS $$
  SELECT COALESCE(regexp_replace($1, '<[^>]*>', ' ', 'g'), '');
$$ LANGUAGE sql IMMUTABLE;

CREATE OR REPLACE FUNCTION generate_embedding_text(bezeichnung text, beschreibung text) RETURNS text AS $$
  SELECT TRIM(
    COALESCE(bezeichnung, '') ||
    CASE WHEN beschreibung IS NOT NULL AND beschreibung != ''
         THEN ' - ' || strip_html(beschreibung)
         ELSE ''
    END
  );
$$ LANGUAGE sql IMMUTABLE;
```

**2. Edge Function lv-embed-regenerate v1:**
- Kombiniert: `bezeichnung + ' - ' + strip_html(beschreibung)`
- Generiert neue Embeddings mit `text-embedding-3-small`
- Speichert kombinierten Text in `embedding_text` zur Nachvollziehbarkeit
- Parameter: `lv_typ`, `batch_size`, `force`
- Batch-Verarbeitung: 20 Embeddings pro OpenAI-Call

**3. telegram-webhook v58:**
- Embedding-basierte LV-Suche via `search_lv_positions` RPC
- Similarity-Threshold: 0.6 (60%)
- Telegram-Ausgabe angepasst:
  - Mit Positionen: Formatierte Liste mit Artikelname, Similarity%, Preis
  - Ohne Positionen: Nur Beschreibung anzeigen
- Positionen werden in `nachtraege.positionen` JSONB gespeichert

### Telegram-Ausgabe (mit gefundenen Positionen)

```
‚úÖ Nachtrag NT-ATBS-456-001 erstellt!
Gemeldet von: Holger Neumann (bauleiter)

üìã Gefundene LV-Positionen:
1. Elektrik: Teilmodernisierung (85% Match)
   ‚Üí 450,00 ‚Ç¨ / St√ºck
2. Steckdose, 2-fach (72% Match)
   ‚Üí 25,00 ‚Ç¨ / St√ºck

Gesch√§tzte Summe: 475,00 ‚Ç¨ netto

Foto hinzuf√ºgen?
```

### Telegram-Ausgabe (ohne Positionen)

```
‚úÖ Nachtrag NT-ATBS-456-001 erstellt!
Gemeldet von: Holger Neumann (bauleiter)

Beschreibung: 3 zus√§tzliche Steckdosen

Keine passenden LV-Positionen gefunden.

Foto hinzuf√ºgen?
```

### Dateien

| Datei | √Ñnderung |
|-------|----------|
| `functions/supabase/functions/telegram-webhook/index.ts` | v58: Embedding-basierte LV-Suche |
| `functions/supabase/functions/lv-embed-regenerate/index.ts` | NEU: Embedding-Regenerierung |

### Neue Learnings

- **L098:** Embedding-basierte Suche ist semantisch robuster als Score-basiertes Keyword-Matching
- **L099:** strip_html entfernt HTML-Tags f√ºr saubere Embeddings
- **L100:** Similarity-Threshold 0.6 ist guter Kompromiss zwischen Precision und Recall

---

## LOG-040 - Telegram-Bot v52-v55 - Nachtrag LV-Position-Matching

**Datum:** 2026-01-30 ~22:00 - 23:30
**Dauer:** ~1.5 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Implementierung eines LV-Position-Matching-Features f√ºr Nachtr√§ge im Telegram-Bot. Bei Nachtrag-Erfassung werden nun automatisch die passenden LV-Positionen basierend auf dem Auftraggeber des Projekts identifiziert und mit Preisen angezeigt.

### Durchgef√ºhrte Arbeiten

**1. Auftraggeber-Extraktion aus Projektname (v52):**
```typescript
function extractAuftraggeberFromName(projektName: string): string {
  const firstPart = projektName.split('|')[0].trim().toLowerCase();
  if (firstPart === 'vbw') return 'VBW';
  if (firstPart === 'gws') return 'GWS';
  if (firstPart === 'covivio') return 'Covivio';
  if (firstPart === 'vonovia') return 'Vonovia';
  // ... weitere Mappings
  return 'neurealis'; // Fallback
}
```

**2. LV-Typ Mapping (v55 - Vonovia-Korrektur):**
```typescript
const mapping = {
  'VBW': 'VBW',
  'GWS': 'GWS',
  'Covivio': 'covivio',
  'Vonovia': 'vonovia',  // Korrektur: Eigener LV-Typ!
  'Privat': 'neurealis',
  'neurealis': 'neurealis',
  'WBG L√ºnen': 'WBG L√ºnen',
};
```

**3. GPT-basiertes Nachtrag-Parsing (v53):**
- GPT-5.2 analysiert freien Text/Spracheingabe
- Extrahiert: Beschreibung, Menge, Einheit, Gewerk
- Beispiel: "3 Steckdosen nachtr√§glich" ‚Üí {beschreibung: "Steckdose nachtr√§glich installieren", menge: 3, einheit: "Stk", gewerk: "Elektrik"}

**4. Score-basiertes LV-Position-Matching (v54):**
```typescript
// Scoring-Algorithmus:
// - Gewerk-Match: +10 Punkte
// - Wort-Match im Namen: +5 Punkte pro Wort
// - Keyword-Match: +15 Punkte (Steckdose, Fliese, etc.)
// - Threshold: >= 10 Punkte f√ºr validen Match
```

**5. Datenbank-Migration:**
- Neue Spalten in `nachtraege`: `positionen` (JSONB), `summe_netto` (NUMERIC)
- Speichert gematchte Positionen mit Preisen strukturiert

### Ausgabe-Format

Bei Nachtrag-Erfassung zeigt der Bot:
```
üìù Nachtrag erfasst

üìã Roh-Text:
"3 steckdosen nachtr√§glich, 5m¬≤ fliesen bad"

üí∞ Gefundene Positionen:
1. Steckdose Komplett inkl. Zuleitung
   3 x 85,00 ‚Ç¨ = 255,00 ‚Ç¨
2. Wandfliesen verlegen (Kermos 20x60)
   5 x 48,50 ‚Ç¨ = 242,50 ‚Ç¨

Summe netto: 497,50 ‚Ç¨
```

### Vonovia-Korrektur

- **Urspr√ºnglich:** Vonovia ‚Üí GWS (falsch!)
- **Korrigiert:** Vonovia ‚Üí 'vonovia' (eigener LV-Typ)
- **Hinweis:** Vonovia-LV noch nicht importiert, aktuell 0 Positionen

### Neue Learnings

- **L096:** Score-basiertes Matching f√ºr LV-Positionen (Gewerk + Keywords + Wort-Overlap)
- **L097:** Auftraggeber-Extraktion aus Monday-Projektnamen (Format: "AG | Adresse | Details")

### Deployment

- telegram-webhook v55 deployed (Supabase Edge Function)
- verify_jwt: false (Telegram Webhook braucht keinen JWT)

### N√§chste Schritte

- Vonovia-LV importieren wenn verf√ºgbar
- Feature mit echten Projekten testen (VBW, GWS, Covivio)

---

## LOG-039 - Softr-Sync mangel_nr Fix + Duplikate-Bereinigung

**Datum:** 2026-01-30 ~21:00 - 21:45
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Reparatur des Softr-Sync f√ºr das `mangel_nr` Feld und Bereinigung von Duplikaten in ATBS-456.

### Durchgef√ºhrte Arbeiten

**1. Softr-Sync mangel_nr Fix (v28):**
- Problem: `mangel_nr` wurde nicht zu Softr synchronisiert
- Ursache: Feld fehlte im FIELD_MAPPINGS der softr-sync Edge Function
- L√∂sung: Softr-Feld-ID `1UqYa` f√ºr mangel_nr ermittelt und eingetragen
- Datenbank-URL-Problem behoben (Supabase Client statt direktes Postgres)

**2. Fehlende M√§ngelnummern nachgetragen:**
- 13 M√§ngel f√ºr ATBS-456 hatten keine mangel_nr
- Nummeriert als M1-M13 basierend auf created_at

**3. Projektname aus Monday erg√§nzt:**
- 16 M√§ngel fehlte `projektname_komplett`
- JSON-Pfad f√ºr ATBS: `column_values->'text49__1'->>'text'`
- Alle 16 M√§ngel mit Monday-Projektnamen aktualisiert

**4. Duplikate bereinigt (ATBS-456):**
- 22 Test-M√§ngel aus Supabase gel√∂scht (M2-M16 inkl. Duplikate)
- Entsprechende Softr-Records gel√∂scht
- Nur ATBS-456-M1 bleibt √ºbrig
- Backup: `docs/backups/2026-01-30_maengel_fertigstellung_ATBS-456_delete.json`

### Neue Learnings

- **L092:** Bauvorhaben-Pflichtfelder bei Telegram-Bot-Eingaben
- **L093:** Softr-Sync mangel_nr Feldmapping

### Ergebnis

| System | ATBS-456 M√§ngel |
|--------|-----------------|
| Supabase | 1 (nur M1) ‚úÖ |
| Softr | 1 (nur M1) ‚úÖ |

---

## LOG-038 - GWS LV-Import 2026 Baupreisindex

**Datum:** 2026-01-30 ~19:00 - 20:30
**Dauer:** ~1.5 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Erfolgreicher Import der GWS Baupreisindex-Aktualisierung August 2025. 771 Positionen aus Excel analysiert, 363 Preise aktualisiert, 110 neue Positionen angelegt.

### Durchgef√ºhrte Arbeiten

**1. Excel-Import mit Node.js:**
```javascript
const XLSX = require('xlsx');
const workbook = XLSX.readFile(pfad);
const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });
```
- Read-Tool kann keine bin√§ren .xlsx lesen ‚Üí Node.js Script
- 771 Zeilen mit Daten importiert

**2. Artikelnummer-Transformation:**
- Excel: `01.01.1` ‚Üí DB: `GWS.LV23-01.01.1`
- Pr√§fix-Logik automatisiert

**3. Dry-Run mit Kategorisierung:**
- 363 Preiserh√∂hungen (durchschnittlich +26.22%)
- 110 neue Positionen (Fenster, HLS, Wei√ü-/Grauware)
- 8 echte Preissenkungen ‚Üí NICHT importiert (User-Entscheidung)
- 74 √úberschriften (Preis = 0) ‚Üí ignoriert
- 216 ohne Match (Headers, Kommentare)

**4. Fallback-Matching deaktiviert:**
- Problem: Stundenlohn-Positionen 12x in Excel (pro Gewerk)
- Fallback √ºber Namen f√ºhrte zu falschen Zuordnungen
- L√∂sung: Nur noch exaktes Artikelnummer-Matching

**5. Backup erstellt:**
- Pfad: `docs/backups/2026-01-30_lv_positionen_gws_import.json`
- Enth√§lt alle 601 Original-GWS-Positionen vor Import

### Import-Ergebnis

| Kategorie | Anzahl | Details |
|-----------|--------|---------|
| Preiserh√∂hungen | 363 | √ò +26.22%, max +85.71% |
| Neue Positionen | 110 | Fenster, HLS, Wei√üware |
| Preissenkungen | 8 | NICHT importiert (alte Preise behalten) |
| √úberschriften | 74 | Ignoriert (Preis = 0) |
| Kein Match | 216 | Headers, Kommentare |

### Verifizierung

```sql
-- Nach Import:
total_gws: 711 (vorher: 601)
heute_importiert: 481
heute_geaendert: 481
```

### Neue Learnings

- L094: Dry-Run-Pflicht f√ºr LV-Imports
- L095: Fallback-Matching bei mehrdeutigen Positionen deaktivieren

---

## LOG-037 - Telegram-Bot v51 - Verbesserte M√§ngel-Erfassung

**Datum:** 2026-01-30 ~17:00 - 18:30
**Dauer:** ~1.5 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Telegram-Bot v51 mit wesentlichen Verbesserungen f√ºr die M√§ngel-Erfassung deployed:
- Automatische Mangelnummern (ATBS-XXX-M1, ATBS-XXX-M2, etc.)
- Verbessertes KI-Parsing f√ºr Wohnungssanierung und Bauleitung
- 3-Tage-Frist statt 7 Tage
- Neuer Foto-Zuordnungs-Workflow f√ºr mehrere M√§ngel

### Durchgef√ºhrte Arbeiten

**1. Mangelnummer-Generierung:**
```typescript
async function generateMangelNummer(projektNr: string): Promise<string> {
  const { count } = await supabase
    .from('maengel_fertigstellung')
    .select('id', { count: 'exact', head: true })
    .eq('projekt_nr', projektNr);

  const nextNum = (count || 0) + 1;
  return `${projektNr}-M${nextNum}`;
}
```
- Format: ATBS-456-M1, ATBS-456-M2, etc.
- Automatische fortlaufende Nummerierung pro Projekt

**2. Verbesserter GPT-Prompt:**
- Kontext: Wohnungssanierung in Deutschland
- Gewerke explizit benannt: Elektrik, Sanit√§r, Maler, Boden, T√ºren, Fenster, Heizung, Trockenbau, K√ºche
- TRENNUNGS-REGELN f√ºr "Mangel 1: ..., Mangel 2: ..."
- Beispiele f√ºr typische M√§ngel je Gewerk

**3. Frist-√Ñnderung:**
- Alte Frist: 7 Tage
- Neue Frist: 3 Tage (3 * 24 * 60 * 60 * 1000 ms)

**4. Foto-Zuordnungs-Workflow:**
- **Bei mehreren M√§ngeln:** Nutzer w√§hlt welchem Mangel das Foto zugeordnet wird
- **Zwei Richtungen:**
  - Mangel ausw√§hlen ‚Üí Foto hochladen
  - Foto hochladen ‚Üí Mangel-Auswahl wenn mehrere offen
- Neue Callbacks: `mangel:foto:{id}`, `mangel:assign:{id}`
- Neue Modi: `mangel_foto_auswahl`, `mangel_foto_zuordnung`

### Neue/Ge√§nderte Funktionen

- `generateMangelNummer(projektNr)` - Mangelnummer generieren
- `selectMangelForFoto(session, maengel)` - Foto-Mangel-Zuordnung Auswahl
- `assignFotoToMangel(session, mangelId, fotoInfo)` - Pending Foto zuordnen
- `handleMangelFoto(session, fotoInfo)` - Erweitert f√ºr Multi-Mangel-Szenario

### Deployment

- Edge Function: `telegram-webhook` v51
- Status: Erfolgreich deployed via Supabase MCP

---

## LOG-036 - LV-Sync Implementierung (T1-T5)

**Datum:** 2026-01-30 ~11:30 - 15:15
**Dauer:** ~3.75 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Umfassende LV-Synchronisations-Infrastruktur implementiert mit 5 parallelen Subagenten:
- T1: Preis-Historie Tabelle + Trigger
- T2: Softr-Push Edge Function + Initial-Sync
- T3: Hero-Push Edge Function + Loop-Vermeidung
- T4: LV-Import Konzept-Dokument
- T5: Erweitertes Preis-Datenmodell (m:n AG, NU-Margen)

### Durchgef√ºhrte Arbeiten

**T1 - Preis-Historie:**
- Tabelle `lv_preis_historie` mit Trigger `trg_lv_preis_historie`
- Automatische Erfassung bei Preis√§nderungen
- Prozentuale √Ñnderung wird berechnet
- Quelle via `SET LOCAL app.change_source` setzbar

**T2 - Softr-Push:**
- Edge Function `lv-softr-push` deployed
- Initial-Push: 1.485 fehlende Positionen erfolgreich synchronisiert
- Finaler Status: 3.057/3.057 (100%) mit softr_record_id
- DB-Trigger `trg_lv_softr_push` f√ºr automatischen Sync

**T3 - Hero-Push:**
- Edge Function `lv-hero-push` deployed (Function ID: 66453b43-076d-4c23-a374-817bf0767bd3)
- Neue Spalten: `hero_product_id`, `source` auf lv_positionen
- Loop-Vermeidung: source='hero' wird nicht zur√ºck gepusht
- Alle 3.057 bestehenden Positionen auf source='hero' gesetzt

**T4 - LV-Import Konzept:**
- 5-Schritt-Workflow: Upload ‚Üí LV-Typ ‚Üí Mapping ‚Üí Validierung ‚Üí Import
- 3 Import-Modi: Neues LV, Preis-Update, Komplett-Ersetzung
- UI-Mockups dokumentiert
- Kl√§rungsfragen zu Artikelnummern, Preisstruktur, gel√∂schten Positionen

**T5 - Preis-Datenmodell:**
- Neue Tabellen: `lv_positionen_auftraggeber`, `nachunternehmer_konditionen`
- m:n Zuordnung Position ‚Üî Auftraggeber mit individuellem EP
- NU-spezifische Margen (pro AG + Gewerk m√∂glich)
- SQL-Funktion `fn_get_position_preis()` f√ºr Preisberechnung
- Kl√§rungsfragen zu Preisrichtung, Marge-Definition, Cross-AG-Positionen

### Neue Migrationen

1. `create_lv_preis_historie` - Preis-Historie Tabelle + Trigger
2. `add_lv_softr_push_trigger` - Softr-Push Trigger
3. `add_lv_positionen_hero_push_columns` - hero_product_id + source Spalten
4. `add_lv_positionen_hero_push_trigger` - Hero-Push Trigger

### Dokumentation

- `docs/LV_SYNC_IMPLEMENTATION.md` - Tracker-Datei
- `docs/implementation/t1_preis_historie.md`
- `docs/implementation/t2_softr_push.md`
- `docs/implementation/t3_hero_push.md`
- `docs/implementation/t4_lv_import_konzept.md`
- `docs/implementation/t5_preis_datenmodell.md`

---

## LOG-035 - LV-Export PDF Styling Fix

**Datum:** 2026-01-30 ~10:00 - 10:30
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

LV-Export PDF Reihenfolge und Styling korrigiert - Name jetzt fett, Artikelnummer grau, keine Leerzeile vor Langtext.

### Durchgef√ºhrte Arbeiten

1. **Reihenfolge ge√§ndert:**
   - Vorher: [Artikelnummer] ‚Üí Bezeichnung ‚Üí Langtext
   - Nachher: Bezeichnung ‚Üí Artikelnummer ‚Üí Langtext

2. **Custom-Rendering implementiert:**
   - jsPDF-autotable erlaubt keine gemischten Styles in einer Zelle
   - L√∂sung: `didDrawCell` Hook f√ºr manuelles Zeichnen
   - `positionDataMap` f√ºr strukturierte Daten pro Zeile

3. **Styling umgesetzt:**
   - Bezeichnung: Helvetica Bold, 9pt, dunkelgrau (45, 55, 72)
   - Artikelnummer: Helvetica Normal, 8pt, mittelgrau (120, 120, 120), ohne Klammern
   - Langtext: Helvetica Normal, 8pt, dunkelgrau (80, 80, 80), keine Leerzeile davor

4. **Deployment:**
   - Netlify manuell deployed (Auto-Deploy war inaktiv)
   - GitHub Commits: `1e133a3`, `aa6b09e`

### Technische Details

**Custom Cell Rendering Pattern:**
```javascript
didDrawCell: (data) => {
  if (data.column.index === 1 && data.section === 'body') {
    const posData = positionDataMap.get(data.row.index);
    if (posData) {
      // Hintergrund √ºbermalen
      doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
      // Text manuell mit verschiedenen Styles zeichnen
      doc.setFont('helvetica', 'bold');
      doc.text(posData.bezeichnung, x, y);
      // ... weitere Styles
    }
  }
}
```

### Neue Learnings

- L085: jsPDF-autotable `didDrawCell` f√ºr gemischte Styles in einer Zelle

---

## LOG-034 - Telegram-Bot v50 Debugging + M√§ngel-Reminder Fix

**Datum:** 2026-01-30 ~00:30 - 01:15
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Telegram-Bot Baustellen-Features debugged - Code war vollst√§ndig, v50 mit Debug-Logging redeployed.

### Durchgef√ºhrte Arbeiten

1. **M√§ngel-Reminder Fix verifiziert:**
   - v5 bereits deployed mit CLOSED_STATUS_VALUES Check
   - Pr√ºft: status_mangel NICHT in ['Abgenommen', 'Abgeschlossen', 'Erledigt', 'Geschlossen']

2. **Telegram-Bot Code-Analyse:**
   - Lokaler Code (v49) war vollst√§ndig mit allen Baustellen-Handlers
   - Deployter Code enthielt alle Callback-Handler (bau:mangel, bau:nachtrag, etc.)
   - Alle Text-Handler implementiert (mangel_erfassen, nachtrag_erfassen)
   - Alle Foto-Handler implementiert (mangel_foto, nachtrag_foto, nachweis_foto)

3. **v50 Redeployment mit Debug-Logging:**
   - Zus√§tzliche console.log Statements f√ºr jeden Handler
   - Logging: `[v50] Callback: data=..., chatId=..., bv_id=...`
   - Version-Bump auf v50 f√ºr klare Identifikation

### Technische Details

**Bot-Workflow f√ºr Baustellen-Features:**
```
1. /start ‚Üí Hauptmen√º
2. "üèóÔ∏è Baustelle √∂ffnen" ‚Üí mode_baustelle Callback
3. "üìã Aktive Projekte" ODER ATBS-Nummer eingeben
4. Projekt ausw√§hlen ‚Üí openProjekt() ‚Üí Session aktualisieren
5. ERST DANN: Mangel/Nachtrag/Nachweis/Status verf√ºgbar
```

**Kritische Session-Felder:**
- `aktuelles_bv_id` - Muss gesetzt sein f√ºr Mangel/Nachtrag
- `modus_daten.projekt_nr` - ATBS-Nummer
- `aktueller_modus` - 'mangel_erfassen', 'nachtrag_erfassen', etc.

### Neue Learnings

- L085: Telegram-Bot erfordert Projekt-√ñffnung vor Erfassung
- L086: Debug-Logging in Edge Functions f√ºr Fehleranalyse

---

## LOG-033 - WordPress-Sync: IONOS Auth-Problem Troubleshooting

**Datum:** 2026-01-29 ~19:00 - 19:45
**Dauer:** ~45 Minuten
**Status:** Blockiert - Wartet auf manuelle Aktion

### Zusammenfassung

WordPress REST API Authentifizierung auf IONOS Hosting funktioniert nicht vollst√§ndig. Authorization Header wird in CGI-Modus gestripped.

### Durchgef√ºhrte Arbeiten

1. **OpenAI Batch API - Cornerstone Artikel:**
   - Batch erfolgreich abgeschlossen
   - "Kernsanierung Komplettsanierung Dortmund 2026" (2.999 W√∂rter)
   - 12000 max_completion_tokens f√ºr lange Artikel

2. **WordPress-Sync Edge Function (bereits deployed v3):**
   - API-Verbindung funktioniert (Test Mode zeigt 3 Posts)
   - Basic Auth mit Application Password implementiert
   - Username: `wcksjjdrwwtx6cona4pc` (lowercase!)

3. **Auth-Problem diagnostiziert:**
   - 401 Fehler: "Du bist mit deiner Benutzerrolle leider nicht berechtigt, Beitr√§ge zu erstellen"
   - Authentication funktioniert (Error wechselte von "rest_not_logged_in" zu "rest_cannot_create")
   - **Root Cause:** IONOS Hosting stripped HTTP Authorization Header im CGI-Modus

4. **.htaccess Fix versucht (FEHLGESCHLAGEN):**
   ```apache
   <IfModule mod_setenvif.c>
   SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
   </IfModule>
   <IfModule mod_rewrite.c>
   RewriteEngine On
   RewriteCond %{HTTP:Authorization} .
   RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
   </IfModule>
   ```
   - Verursachte 500 Internal Server Error
   - .htaccess zur√ºck auf Original gesetzt

### Technische Details

**IONOS-spezifisches Problem:**
- Apache im CGI-Modus (nicht mod_php) stripped Authorization Header
- Standard-.htaccess Fixes funktionieren nicht bei IONOS
- Alternative: WordPress Plugin f√ºr alternative Auth-Methode n√∂tig

**Credentials (in Supabase Secrets):**
- WORDPRESS_USERNAME: wcksjjdrwwtx6cona4pc
- WORDPRESS_APP_PASSWORD: HejP z1LV jygM WSPD E3z7 YEqr

### Offene Punkte (MANUELL ERFORDERLICH)

1. **Option A:** WordPress Plugin "Application Passwords Workaround" installieren
2. **Option B:** IONOS Support kontaktieren wegen PHP-Handler (CGI ‚Üí FPM)
3. **Option C:** wp-config.php Modification (erfordert FTP-Zugang)

### Neue Learnings

- L083: IONOS Hosting stripped Authorization Header im CGI-Modus
- L084: .htaccess Auth-Fixes k√∂nnen 500 Errors verursachen

---

## LOG-032 - Telegram-Bot v49 + M√§ngel-Reminder Fix

**Datum:** 2026-01-29 ~15:00 - 16:00
**Dauer:** ~60 Minuten
**Status:** Abgeschlossen

### Durchgef√ºhrte Arbeiten

1. **M√§ngel-Reminder Fix (v5)**
   - Problem: Erinnerungen wurden verschickt obwohl `status_mangel` geschlossen war
   - L√∂sung: Query erweitert um geschlossene Status auszuschlie√üen
   - Werte: 'Abgenommen', 'Abgeschlossen', 'Erledigt', 'Geschlossen'

2. **Telegram-Bot v49 - Baustellen-Features**
   - Neues Hauptmen√º: "üèóÔ∏è Baustelle √∂ffnen"
   - Projekt-Suche: ATBS-Nummer oder Liste aktiver Projekte (Phase 2-4)
   - Mangel melden: Text/Sprache, mehrsprachig, Auto-Splitting, Foto
   - Nachtrag erfassen: Text + Foto, automatische Nummern (NT-ATBS-001)
   - Nachweis hochladen: Typ-Auswahl (Elektrik/Sanit√§r/Abdichtung/E-Check)
   - Status anzeigen: Offene M√§ngel/Nachtr√§ge/Nachweise
   - Bestehende Features (Aufma√ü, Bedarfsanalyse) unver√§ndert

3. **Angebots-Edge-Functions Analyse**
   - finalize-angebot v30: Bedarfsanalyse ‚Üí Angebot (GPT-Matching)
   - generate-bestellung-pdf v6: PDF mit Corporate Design
   - bestellung-submit v16: E-Mail via MS Graph

4. **GitHub + Netlify Deployment**
   - Commit 17a2a6d: 26 Dateien, +9.336 Zeilen
   - Auto-Deploy auf Netlify aktiv

### Ergebnisse

- telegram-webhook v49 deployed
- mangel-reminder v5 deployed
- GitHub main branch aktualisiert
- Netlify Build getriggert

---

## LOG-031 - WordPress-Sync v3 + Marketing-RLS-Fix

**Datum:** 2026-01-29 ~18:00 - 18:30
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

WordPress-Sync Edge Function erweitert f√ºr direkte Ver√∂ffentlichung bei Freigabe im ERP + RLS-Policy f√ºr Marketing-Seite gefixt.

### Durchgef√ºhrte Arbeiten

1. **WordPress-Sync v3 deployed:**
   - Neuer Mode: `freigeben` - Push + sofort ver√∂ffentlichen
   - Mode: `draft` - Nur als Entwurf f√ºr Vorschau
   - Mode: `unpublish` - Zur√ºck auf Draft setzen
   - Korrektur Username (lowercase): `wcksjjdrwwtx6cona4pc`
   - Test-Mode f√ºr Verbindungspr√ºfung

2. **Marketing-Seite RLS-Fix:**
   - Problem: Seite war leer (nur authenticated User konnten lesen)
   - L√∂sung: RLS-Policy `Anon users can read blog_posts` hinzugef√ºgt
   - Migration: `add_anon_read_blog_posts`

3. **WordPress-Auth Problem identifiziert:**
   - API-Verbindung funktioniert (Test erfolgreich, 3 Posts)
   - 401 bei POST: "Du bist mit deiner Benutzerrolle leider nicht berechtigt"
   - Ursache: WordPress-User hat keine Editor/Admin-Rolle
   - **Fix ben√∂tigt:** In WordPress diesem User die Rolle "Redakteur" geben

### Technische Details

**wordpress-sync Modi:**
```
mode: 'test'      ‚Üí Verbindung pr√ºfen
mode: 'freigeben' ‚Üí Push + sofort ver√∂ffentlichen (blog_post_id erforderlich)
mode: 'draft'     ‚Üí Nur als Entwurf pushen
mode: 'unpublish' ‚Üí Ver√∂ffentlichten Post zur√ºck auf Draft
```

**RLS-Policy:**
```sql
CREATE POLICY "Anon users can read blog_posts"
ON blog_posts FOR SELECT TO anon USING (true);
```

### Offene Punkte

- [ ] WordPress-User `wcksjjdrwwtx6cona4pc` Rolle "Redakteur" geben
- [ ] Dann Test-Artikel ver√∂ffentlichen

---

## LOG-030 - Blog-WordPress-Sync Edge Function

**Datum:** 2026-01-29 ~17:00 - 17:15
**Dauer:** ~15 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Implementierung einer Edge Function zur Synchronisation von Blog-Artikeln von Supabase nach WordPress.

### Durchgef√ºhrte Arbeiten

1. **Recherche WordPress REST API:**
   - Application Passwords seit WordPress 5.6 verf√ºgbar
   - Basic Auth mit Base64-encoded Credentials
   - POST /wp-json/wp/v2/posts f√ºr Create/Update

2. **Edge Function `blog-wordpress-sync` v1 deployed:**
   - Holt alle blog_posts mit status='veroeffentlicht' und review_status='approved'
   - Duplikat-Check via wordpress_post_id oder Slug
   - Erstellt neue Posts oder aktualisiert bestehende
   - Speichert wordpress_post_id, wordpress_synced_at, wordpress_sync_status

3. **Features:**
   - `dry_run: true` Parameter f√ºr sichere Tests
   - `post_id` Parameter f√ºr einzelnen Post
   - Fehler-Status wird in Supabase gespeichert
   - Rate-Limiting-Pause (500ms) zwischen Posts

### Technische Details

**WordPress REST API Authentication:**
```javascript
const authHeader = `Basic ${btoa(`${username}:${app_password}`)}`;
```

**Ben√∂tigte Secrets:**
- WORDPRESS_URL (Default: https://neurealis.de)
- WORDPRESS_USER
- WORDPRESS_APP_PASSWORD

**Application Password erstellen:**
1. WordPress Admin -> Benutzer -> Profil
2. Runterscrollen zu "Anwendungspassw√∂rter"
3. Name eingeben (z.B. "Supabase Sync")
4. "Neues Anwendungspasswort hinzuf√ºgen"
5. Generiertes Passwort kopieren (nur einmal sichtbar!)

### N√§chste Schritte

1. WordPress Application Password erstellen
2. Secrets in Supabase setzen
3. Dry-Run testen
4. Live-Sync durchf√ºhren
5. Optional: Cron-Job f√ºr automatischen Sync einrichten

---

## LOG-028 - SharePoint-Sync: Client Credentials Flow

**Datum:** 2026-01-29 ~12:00 - 14:30
**Dauer:** ~2,5 Stunden
**Status:** Abgeschlossen ‚úÖ

### Zusammenfassung

Umstellung SharePoint-Sync von Delegated Permissions (refresh_token) auf Application Permissions (Client Credentials Flow). **Alle Probleme behoben.**

### Durchgef√ºhrte √Ñnderungen

**Azure AD App:**
- Application Permissions: Sites.Read.All, Files.Read.All
- Admin Consent erteilt
- Delegated Permissions zus√§tzlich konfiguriert

**Edge Function `sharepoint-sync` (v5 ‚Üí v9):**
- v5: Client Credentials Flow (kein User-Login)
- v6: Delta-Query ohne $select
- v7: Debug-Logging hinzugef√ºgt
- v8: Storage-Bucket von `dokumente` (existiert nicht!) auf `softr-files` umgestellt
- v9: `dokument_nr` von 8 auf 16 Zeichen erweitert (Unique-Constraint)

### Behobene Probleme

| Problem | Ursache | L√∂sung |
|---------|---------|--------|
| Download-Fehler | Storage-Bucket `dokumente` existierte nicht | Auf `softr-files` umgestellt |
| DB-Insert scheiterte | `dokument_nr` Unique-Constraint (8 Zeichen zu kurz, mehrere IDs beginnen mit `01VBIR76`) | Auf 16 Zeichen erweitert |
| Fehler nicht erkannt | Insert/Update ohne Error-Handling | Fehler werden jetzt geloggt |

### Finaler Status

| Komponente | Status | Details |
|------------|--------|---------|
| Token-Abruf | ‚úÖ | Client Credentials funktioniert |
| Sites.Read.All | ‚úÖ | Site-ID, Drive-ID abrufbar |
| Files.Read.All | ‚úÖ | Delta-Query gibt Items |
| Download | ‚úÖ | 302 ‚Üí Location ‚Üí Blob |
| Storage-Upload | ‚úÖ | softr-files Bucket |
| DB-Insert | ‚úÖ | 14 Dokumente synchronisiert |

### Test-Ergebnis

```json
{
  "success": true,
  "version": 9,
  "filesDownloaded": 13,
  "errors": 0,
  "storage_bucket": "softr-files"
}
```

### Neue Erkenntnisse (L073-L075)

- L073: Storage-Bucket muss existieren bevor Edge Function darauf schreibt
- L074: Unique-Constraints bei generierten IDs - Prefix-L√§nge pr√ºfen!
- L075: Immer Error-Handling f√ºr DB-Operationen in Edge Functions

---

## LOG-029 - Blog-Pipeline: Cornerstone 3000-W√∂rter-Artikel

**Datum:** 2026-01-29 ~16:00 - 16:45
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen ‚úÖ

### Zusammenfassung

Erfolgreicher Test der Blog-Pipeline mit OpenAI Batch API f√ºr lange Cornerstone-Artikel (3000 W√∂rter).

### Durchgef√ºhrte √Ñnderungen

**blog-batch-submit v6:**
- `max_completion_tokens: 12000` f√ºr Cornerstone-Artikel (statt 4000)
- Cornerstone-Detection: `priority >= 100` ODER expliziter Parameter
- Erweiterter System-Prompt mit 10-Sektionen-Struktur f√ºr 3000+ W√∂rter
- Pflicht-Abschnitte definiert (Einleitung, Kosten, Ablauf, F√∂rderungen, etc.)

**blog-batch-poll v4:**
- Deutsche Status-Werte (`entwurf`, `veroeffentlicht`)
- Erweiterte Status-Suche (`submitted`, `validating`, `in_progress`, `finalizing`)

### Test-Ergebnis

**Eingabe:**
- Keyword: "kernsanierung komplettsanierung dortmund 2026"
- Priority: 100 (Cornerstone)
- max_completion_tokens: 12000

**Ausgabe:**
- Titel: "Kernsanierung & Komplettsanierung in Dortmund 2026: Ablauf, Kosten, F√∂rderungen und Praxis-Guide f√ºrs Ruhrgebiet"
- **word_count: 2.999** (praktisch 3000!)
- Status: veroeffentlicht
- Cluster: pillar-1-sanierung

### Erstellte Artikel (gesamt)

| Artikel | W√∂rter | Typ |
|---------|--------|-----|
| Kernsanierung Komplettsanierung Dortmund 2026 | 2.999 | **Cornerstone** |
| GEG Sanierungspflicht Vermieter 2026 | 1.123 | Standard |
| Wohnung sanieren Kosten 2026 | 975 | Standard |
| Wohnungssanierung Dortmund 2026 | 893 | Standard |
| Komplettsanierung Bochum 2026 | 863 | Standard |
| Badsanierung Dortmund 2026 | 853 | Standard |

### Neue Erkenntnisse (L076-L077)

- L076: max_completion_tokens: 12000 n√∂tig f√ºr 3000-W√∂rter-Artikel
- L077: OpenAI Batch API funktioniert zuverl√§ssig auch f√ºr lange Content-Pieces

---

## LOG-027 - M√§ngel-Erinnerungssystem: 2-Phasen-Logik

**Datum:** 2026-01-29 ~11:00 - 12:15
**Dauer:** ~1,25 Stunden
**Status:** Abgeschlossen

### Zusammenfassung

Erweiterung des bestehenden `mangel-reminder` Systems um eine 2-Phasen-Logik:
- Phase 1: NU erh√§lt Erinnerungen bis Nachweis-Foto hochgeladen
- Phase 2: Bauleiter erh√§lt Erinnerungen zur Abnahme

### Implementierte √Ñnderungen

**Supabase:**
- Spalte `erinnerung_status` (Default: 'Aktiv')
- Spalte `letzte_erinnerung_bl_am` (Tracking BL)
- Spalte `erinnerung_bl_count` (Anzahl BL-Erinnerungen)

**Softr (via API erstellt):**
- Erinnerung Status (Select: Aktiv/Pausiert)
- Letzte Erinnerung NU (DateTime)
- Erinnerung Count NU (Number)
- Letzte Erinnerung BL (DateTime)
- Erinnerung Count BL (Number)

**Edge Function:**
- `mangel-reminder` v13 deployed
- 2-Phasen-Logik implementiert
- Auto-Stopp bei status_mangel = 'Abgenommen'

### Logik

```
PHASE 1: NU-Erinnerung
  Wenn: erinnerung_status='Aktiv' UND fotos_nachweis_nu LEER
  ‚Üí E-Mail an NU alle 2 Tage

PHASE 2: BL-Erinnerung (automatisch)
  Wenn: fotos_nachweis_nu BEF√úLLT UND nicht abgenommen
  ‚Üí E-Mail an Bauleiter alle 2 Tage

STOPP:
  - status_mangel = 'Abgenommen'
  - erinnerung_status = 'Pausiert'
```

### Neue Erkenntnisse

- Softr Tables API unterst√ºtzt POST /fields zum Erstellen von Feldern
- Softr Tables API unterst√ºtzt KEIN PATCH f√ºr Feld-Updates (nur Records)
- Field-Mapping in `softr_sync_config` f√ºr bidirektionalen Sync

---

## LOG-026 - Blog-Pipeline Implementierung (T1-T8)

**Datum:** 2026-01-29 ~08:30 - 16:00
**Dauer:** ~7 Stunden
**Status:** Abgeschlossen (T9 E2E-Test noch offen)

### Zusammenfassung

Vollst√§ndige Implementierung der automatisierten Blog-Pipeline f√ºr SEO-optimierte Blogartikel. 8 von 9 Tasks abgeschlossen, End-to-End-Test hat Timeout-Problem.

### Implementierte Komponenten

**T1 - DB-Migrationen:**
- `blog_keywords` Tabelle (23 Test-Keywords)
- `blog_pipeline_runs` Tabelle (Pipeline-Tracking)
- `blog_posts` erweitert (embedding, cluster, confidence_score, etc.)
- RPCs: `search_similar_blog_posts`, `get_next_blog_keyword`

**T2-T6 - Edge Functions (alle deployed):**

| Function | Version | Beschreibung |
|----------|---------|--------------|
| `blog-editor` | v1 | Redaktionschef - Briefing erstellen |
| `blog-research` | v3 | Web-Recherche via Chat Completions |
| `blog-writer` | v2 | SEO-Artikel mit Brand Voice |
| `blog-orchestrate` | v2 | Pipeline-Koordinator |
| `blog-crosslink` | v2 | W√∂chentliche Embedding-Vernetzung |

**T7 - Test-Keywords:**
23 Keywords in 4 Clustern eingef√ºgt:
- pillar-1-sanierung (8 Keywords)
- pillar-2-vermieter (7 Keywords)
- pillar-3-regional (4 Keywords)
- pillar-4-kompass (4 Keywords)

**T8 - Cron-Jobs:**
- `blog-orchestrate-daily`: `0 8 * * *` (t√§glich 8:00 UTC)
- `blog-crosslink-weekly`: `0 6 * * 0` (sonntags 6:00 UTC)

### Einzeltest-Ergebnisse

| Function | Status | Ergebnis |
|----------|--------|----------|
| blog-editor | ‚úÖ | Vollst√§ndiges Briefing JSON, 2 interne Links |
| blog-research | ‚úÖ | 6 Fakten, Trends, Lokaldaten NRW |
| blog-writer | ‚úÖ | 1.126 W√∂rter, 6 interne Links, Confidence 0.6 |

### Bekanntes Problem (T9)

**E2E-Test scheitert:** blog-orchestrate ruft sequentiell editor‚Üíresearch‚Üíwriter auf. Der writer-Call endet mit "Keine Antwort von OpenAI erhalten" (Timeout).

**Ursache:** Edge Function Timeout (60s) wird bei Chain von 3 API-Calls √ºberschritten.

**L√∂sungsans√§tze:**
1. Async/Callback-Pattern
2. Queue-basierte Verarbeitung
3. Supabase Pro Plan (150s Timeout)

### Neue Learnings

- L062: OpenAI Responses API vs. Chat Completions
- L063: verify_jwt f√ºr interne Edge Function Calls
- L064: Edge Function Timeouts bei Chain-Calls
- L065: Supabase Cron mit pg_cron

### Kritik / Lessons Learned

**Problem:** Hauptchat-Kontext wurde durch Edge Function Code gef√ºllt statt Subagenten zu nutzen.

**Besserer Ansatz f√ºr Overnight-Tasks:**
1. Tracker-Datei f√ºr Koordination (`docs/IMPLEMENTATION_TRACKER.md`)
2. Subagenten f√ºr jeden Task mit eigener Output-Datei
3. Hauptchat nur f√ºr Koordination und Status-Updates
4. `run_in_background: true` f√ºr lang laufende Tasks

---

## LOG-025 - Telegram-Bot v2.0 + Edge Function Backups

**Datum:** 2026-01-29 ~11:00
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Telegram-Bot v2.0 mit vollst√§ndiger Mangel/Nachtrag/Foto-Funktionalit√§t implementiert.
Edge Function Backup-Strategie etabliert.

### Telegram-Bot v2.0 Features

- **Mangel erfassen:** KI-Analyse splittet mehrere M√§ngel automatisch
- **Nachtrag erfassen:** Mit Foto-Upload und Beschreibung
- **Foto-Upload:** In Supabase Storage (neuer `fotos` Bucket)
- **Sprach-zu-Text:** Whisper-Integration f√ºr mehrsprachige Eingabe (DE, RU, HU, RO, PL)
- **Nachweis-Upload:** Typ-Auswahl (Rohinstallation, E-Check, etc.)
- **Kritische Regel:** M√§ngel/Nachtr√§ge/Fotos NUR wenn Projekt ge√∂ffnet!

### Edge Functions Backup

Wichtige Erkenntnis: Bedarfsanalyse und Aufma√ü sind **separate** Functions, wurden NICHT √ºberschrieben:

| Function | Version | Status |
|----------|---------|--------|
| `process-bedarfsanalyse` | v31 | ‚úÖ Aktiv |
| `process-aufmass-complete` | v29 | ‚úÖ Aktiv |
| `generate-aufmass-excel` | v20 | ‚úÖ Aktiv |
| `telegram-webhook` | v46 | ‚úÖ Neu deployed |

Backups erstellt in `backups/edge-functions/`:
- `process-bedarfsanalyse_v31.ts`
- `process-aufmass-complete_v29.ts`

### SharePoint-Sync

- Edge Function deployed, aber Download-Fehler (Token-Problem)
- Subagent arbeitet an Fix

### Neue Learnings

- L058: Nie bestehende Edge Functions √ºberschreiben
- L059: Parallele Subagenten f√ºr komplexe Implementierungen
- L060: Backups von Edge Functions erstellen
- L061: Edge Functions Struktur verstehen

---

## LOG-024 - Dokumentenmanagement-System: Telegram-Bot + SharePoint-Sync

**Datum:** 2026-01-29 ~02:00
**Dauer:** ~60 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Ganzheitliches Dokumentenmanagement-System geplant und erste Komponenten implementiert:
- Telegram-Bot f√ºr Baustellen-Kommunikation
- SharePoint-Sync f√ºr ~90 GB Unternehmensdaten
- 4-stufiges Sicherheitskonzept (RLS)

### Architektur-Entscheidungen

**Ingest-Quellen (Priorit√§t):**
1. Telegram-Bot (Prio 1) - Fotos, M√§ngel, Nachtr√§ge, Sprache
2. SharePoint-Sync (Prio 2) - ~90 GB, parallel im Hintergrund
3. Teams-Transkripte (Prio 3) - Graph API
4. E-Mail + Hero (existiert bereits)

**Sicherheitsstufen:**
| Stufe | Zugriff | Beispiel |
|-------|---------|----------|
| 1 | Alle Mitarbeiter | Projekte, Marketing |
| 2 | Bauleiter + GF | Preise, Vertrieb |
| 3 | GF + Buchhaltung | Finanzen |
| 4 | Nur GF | Personal, Management |

### DB-Migrationen (6 St√ºck)

1. `kontakt_typen` - 9 Rollen (ADM, GF, BL, HW, BH, NU, LI, KU, AP)
2. `fotos` - Baustellen-Fotos mit Kategorien + Vision-Labels
3. `telegram_sessions` - Bot-State pro Chat
4. `erinnerungen` - Erinnerungs-System
5. `kontakte` erweitert - telegram_chat_id, rolle, sprache
6. `dokumente` - sicherheitsstufe + Umlaute korrigiert

### Edge Functions Deployed

| Function | Version | Beschreibung |
|----------|---------|--------------|
| `telegram-webhook` | v44 | Bot-Handler, verify_jwt: false |
| `sharepoint-sync` | v1 | Delta-Sync, Sicherheitsstufen |

### Telegram-Bot Features

- `/start`, `/hilfe`, `/projekt`, `/heute`, `/status`
- Foto-Upload mit Kategorisierung (Mangel, Nachtrag, Nachweis, Doku)
- Sprach-Auswahl (DE, RU, HU, RO, PL)
- Projekt-Suche via ATBS oder Adresse

### SharePoint-Sync Konfiguration

**Download:** PDF, DOCX, XLSX, JPG, PNG (max 50 MB)
**Link-Only:** MP4, MOV, AVI (Videos nur verlinken)
**Ausgeschlossen:** HN Privat, H&H Privat, Mieterservice

### Parallele Subagenten

3 Subagenten gleichzeitig f√ºr maximale Effizienz:
1. DB-Migrationen
2. Telegram-Bot
3. SharePoint-Sync (im Hintergrund)

### N√§chste Schritte

1. Telegram-Bot testen (@neurealis_bedarfsanalyse_bot)
2. SharePoint-Sync starten (action=sync)
3. Cron-Jobs einrichten
4. RLS-Policies implementieren

---

## LOG-023 - Blog-Pipeline Plan Finalisierung

**Datum:** 2026-01-29 ~01:30
**Dauer:** ~20 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Detaillierten Blog-Pipeline-Plan erstellt, optimal auf neurealis Komplettsanierung zugeschnitten.

### Erstellte Dokumentation

**Datei:** `docs/blog_pipeline/BLOG_PIPELINE_PLAN.md`

**Inhalte:**
- 3-Agenten-Architektur (Editor ‚Üí Research ‚Üí Writer)
- 4 Themen-Cluster (Sanierung, Vermieter, Regional, Sanierungskompass)
- Brand Voice Guidelines mit neurealis-USPs
- DB-Schema (blog_keywords, blog_pipeline_runs, Embeddings)
- 5 Edge Functions spezifiziert
- Implementierungs-Roadmap (5 Phasen)
- Erfolgskriterien (30+ Artikel in 3 Monaten)

### Verwendete Wissensquellen

- `wissen/marketing_strategie.md` - Content-Cluster, Sanierungskompass
- `wissen/business_strategie.md` - Zielgruppen, Schema N, USPs
- `wissen/wettbewerber_analyse.md` - Differenzierung, Claims

### N√§chste Schritte

1. Plan-Review durch User
2. Phase 1: DB-Migrationen
3. Phase 2: Edge Functions implementieren

---

## LOG-022 - Ausf√ºhrungsart-basierte Nachweis-Filterung v19

**Datum:** 2026-01-29 ~01:00
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Edge Function `schlussrechnung-nachweis-check` erweitert um intelligente Nachweis-Filterung basierend auf Ausf√ºhrungsart (L051).

### Implementierte Logik

**Elektrik (color590__1):**
| Ausf√ºhrung | Rohinstallation E | E-Check |
|------------|-------------------|---------|
| Komplett | ‚úÖ | ‚úÖ |
| Teil-Mod/Feininstall/E-Check | ‚ùå | ‚úÖ |
| Ohne | ‚ùå | ‚ùå |

**Bad (status23__1):**
| Ausf√ºhrung | Rohinstallation S | Abdichtung |
|------------|-------------------|------------|
| Komplett | ‚úÖ | ‚úÖ |
| Fliese auf Fliese | ‚ùå | ‚úÖ |
| Nur Austausch/Ohne | ‚ùå | ‚ùå |

### Technische √Ñnderungen

- `ermittleErforderlicheNachweise()` - Neue Funktion f√ºr Ausf√ºhrungsart-Mapping
- `pruefeNachweise()` - Akzeptiert jetzt gefilterte Nachweisliste
- Performance: Monday-Daten nur einmal laden (statt pro Schlussrechnung)
- Typo-Toleranz: "feininstall" statt "feininstallation" f√ºr Matching
- E-Mail-Template zeigt Ausf√ºhrungsart zur Nachvollziehbarkeit

### Ergebnis

- 87 Schlussrechnungen gepr√ºft
- 295 erforderliche Nachweise (statt 348 bei immer 4)
- 8 BV komplett ohne Nachweis-Anforderung
- **~15% weniger falsche Nachweis-Anforderungen**

### Git

- Commit: `0174b62`
- Push: ‚úÖ

---

## LOG-021 - Wissens-Indizierung Phase 2 (Wettbewerb + Business Plan)

**Datum:** 2026-01-29 ~00:30
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Fortsetzung der Wissensindizierung f√ºr Blog-Pipeline. Wettbewerbsanalyse und Business Plan extrahiert und strukturiert.

### Verarbeitete Dokumente

| Dokument | Inhalt |
|----------|--------|
| Wettbewerbsanalyse ‚Äì √úberblick.pdf | 5 Wettbewerbergruppen, Positionierung, Marketing-Ma√ünahmen |
| Business Plan 2025-04-12.txt | Vision, Zielgruppen, Schema N, Wachstumspfade (57k tokens) |

### Erstellte Wissensdateien

| Datei | Inhalt |
|-------|--------|
| `wettbewerber_analyse.md` | 5 Gruppen, 10+ Konkurrenten, SEO-Keywords, A/B-Tests |
| `business_strategie.md` | Vision/Mission, Zielgruppen, Leistungspalette, Wachstumspfade |

### Korrekturen

- L049 korrigiert: Subagenten K√ñNNEN lokal synchronisierte Dateien lesen

### Wissens-Ordner komplett

```
wissen/
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ vertrieb_prozesse.md
‚îú‚îÄ‚îÄ marketing_strategie.md
‚îú‚îÄ‚îÄ wettbewerber_analyse.md
‚îî‚îÄ‚îÄ business_strategie.md  ‚Üê NEU
```

---

## LOG-020 - Nachweis-Logik Analyse (Ausf√ºhrungsarten)

**Datum:** 2026-01-29 ~00:00
**Dauer:** ~30 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Analyse der Monday-Bauprozess-Spalten f√ºr Gewerks-Ausf√ºhrungsarten. Ziel: Nachweis-E-Mails nur f√ºr tats√§chlich ausgef√ºhrte Gewerke anfordern.

### Analysierte Spalten

| Spalte | Gewerk | Relevante Werte |
|--------|--------|-----------------|
| `color590__1` | Elektrik | Komplett, Teil-Mod, Austausch Feininstallation, Nur E-Check, Ohne |
| `status23__1` | Bad | Komplett, Fliese auf Fliese, Nur Austausch Sanit√§rartikel, Ohne Bad |
| `color78__1` | Boden | Vinyl (Planken), Laminat, Ausgleich, Holz schleifen, Fliesen, Ohne |
| `color427__1` | W√§nde | Raufaser & Anstrich, 2x Anstrich, Q2 & Anstrich, Nur Spachteln, Ohne |
| `color97__1` | T√ºren | T√ºrbl√§tter: neu \| Zarge: neu, lackieren \| lackieren, Ohne |
| `color49__1` | Therme | Therme versetzen, Neue Therme, Asbestsanierung, Ohne Therme |

### Nachweis-Logik definiert

**Elektrik:**
- Komplett ‚Üí Rohinstallation Elektrik + E-Check
- Teil-Mod/Austausch Feininstallation/Nur E-Check ‚Üí nur E-Check
- Ohne ‚Üí keine Nachweise

**Bad:**
- Komplett ‚Üí Rohinstallation Sanit√§r + Abdichtung
- Fliese auf Fliese ‚Üí nur Abdichtung
- Nur Austausch Sanit√§rartikel/Ohne Bad ‚Üí keine Nachweise

### Dokumentation

- L051 in learnings.md: Vollst√§ndige Nachweis-Logik nach Ausf√ºhrungsart

### N√§chster Schritt

- Edge Function erweitern um Ausf√ºhrungsart-basierte Nachweis-Filterung

---

## LOG-019 - Wissens-Indizierung f√ºr Blog-Pipeline

**Datum:** 2026-01-28 ~23:45
**Dauer:** ~20 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Extraktion und Strukturierung von Sales/Marketing-Wissen aus internen PDFs f√ºr die Blog-Pipeline und Content-Marketing.

### Verarbeitete Dokumente

| Dokument | Inhalt |
|----------|--------|
| Besprechnung Angebot - Eil.pdf | Sales-Pr√§sentation, 31 Folien, Ablauf Angebotsbesprechung |
| Besprechnung Angebot - Blume.pdf | Privatkunden-Beispiel, DHH 120m¬≤, 159k‚Ç¨ |
| Sanierungskompass.pdf | Beratungsprodukt, 3 Varianten (499-999‚Ç¨) |

### Erstellte Wissensdateien

```
wissen/
‚îú‚îÄ‚îÄ README.md             # Index
‚îú‚îÄ‚îÄ vertrieb_prozesse.md  # Sales-Ablauf, USPs, Kennzahlen
‚îî‚îÄ‚îÄ marketing_strategie.md # Sanierungskompass, Positionierung
```

### Extrahierte Kern-Informationen

**F√ºr Blog-Content:**
- Kunden-Pain-Points mit Zahlen (600‚Ç¨/Monat Leerstand, +25% Nachtr√§ge)
- USPs: Dreiklang, Fixpreis, Digitale Bausteuerung
- Kennzahlen: 98% Termintreue, 95% Fixpreis-Quote, >500 Wohnungen
- Content-Cluster: Sanierungswissen, Gewerke, Vermieterwissen, Regional

**F√ºr Sales-Schulung:**
- 6-Phasen Angebotsbesprechung
- Privat vs. B2B Unterschiede
- Angebots-Beispiele mit Positionen

---

## LOG-018 - Blog-Pipeline Planung (3-Agenten-System)

**Datum:** 2026-01-28 ~15:00
**Dauer:** ~45 Minuten
**Status:** Geplant (Implementierung ausstehend)

### Zusammenfassung

Vollst√§ndige Planung einer automatisierten Blog-Erstellungs-Pipeline mit 3-Agenten-Hierarchie (Redaktionschef, Recherche, Writer). T√§glicher Cron-Trigger f√ºr SEO-optimierte Blogartikel.

### Architektur geplant

```
CRON (t√§glich) ‚Üí blog-orchestrate
                      ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚ñº                 ‚ñº                 ‚ñº
blog-editor     blog-research     blog-writer
(Themenwahl)    (Web-Recherche)   (Artikel)
```

### Geplante Edge Functions

| Function | Verantwortung |
|----------|---------------|
| `blog-orchestrate` | Koordiniert Pipeline |
| `blog-editor` | Themenwahl (Redaktionschef) |
| `blog-research` | Web-Recherche via OpenAI |
| `blog-writer` | Artikel schreiben |
| `blog-crosslink` | W√∂chentliche Nachvernetzung |

### DB-Schema-Erweiterungen geplant

- `blog_posts.embedding` (vector 1536) f√ºr Similarity Search
- `blog_keywords` Tabelle f√ºr AHREFS-Daten
- `blog_pipeline_runs` f√ºr Monitoring
- RPC `search_similar_blog_posts` f√ºr Querverlinkung

### Offene Punkte

- AHREFS-Keywords: CSV-Import sp√§ter
- Wissen-Dateien: System-Prompt aufbereiten
- Claude Opus 4.5: Sp√§ter f√ºr Writer-Agent

### Plan-Datei

`C:\Users\holge\.claude\plans\tender-brewing-wigderson.md`

---

## LOG-017 - Hero-Sync Betr√§ge-Bug-Fix + Wiederherstellung

**Datum:** 2026-01-28 ~22:00
**Dauer:** ~60 Minuten

### Zusammenfassung

Bug-Fix f√ºr `hero-document-sync` Edge Function: √úberschreiben von existierenden Netto/Brutto-Werten mit 0 verhindert. 11 Dokumente aus Softr-Backup wiederhergestellt.

### Durchgef√ºhrte Arbeiten

**1. Root-Cause-Analyse:**
- Bug: `const netto = doc.value || 0;` setzte 0 wenn Hero keinen Wert lieferte
- Upsert √ºberschrieb dann existierende Supabase-Werte mit 0
- Betroffen: 12 Dokumente (11 wiederherstellbar, 1 bereits korrekt)

**2. Bug-Fix (hero-document-sync v13):**
- Betr√§ge werden nur noch ins Record aufgenommen wenn Hero tats√§chlich Werte hat
- `hasHeroValues`-Check vor Aufnahme ins Upsert-Record
- Verhindert √úberschreiben von existierenden Daten

**3. Wiederherstellung aus Softr-Backup:**

| Dokument | Netto | Brutto |
|----------|-------|--------|
| NUA-355 | 27.915,00 ‚Ç¨ | 33.218,85 ‚Ç¨ |
| NUA-357 | 8.662,50 ‚Ç¨ | 10.308,38 ‚Ç¨ |
| NUA-358 | 7.350,00 ‚Ç¨ | 8.746,50 ‚Ç¨ |
| NUA-359 | 4.200,00 ‚Ç¨ | 4.998,00 ‚Ç¨ |
| NUA-363 | 14.700,00 ‚Ç¨ | 17.493,00 ‚Ç¨ |
| NUA-364 | 18.900,00 ‚Ç¨ | 22.491,00 ‚Ç¨ |
| NUA-365 | 22.365,00 ‚Ç¨ | 26.614,35 ‚Ç¨ |
| NUA-366 | 21.000,00 ‚Ç¨ | 24.990,00 ‚Ç¨ |
| 2100021040 | 428,57 ‚Ç¨ | 510,00 ‚Ç¨ |
| R-00156 | 9.177,73 ‚Ç¨ | 10.921,50 ‚Ç¨ |
| R-00173 | 7.879,31 ‚Ç¨ | 9.376,38 ‚Ç¨ |
| **Gesamt** | **142.578,11 ‚Ç¨** | **169.668,96 ‚Ç¨** |

**4. Vergleich Softr vs. Supabase:**

| Typ | Softr | Supabase | Differenz |
|-----|-------|----------|-----------|
| ER-* | 605 | 598 | 7 (vor 2025) |
| AR-* | 144 | 142 | 2 (vor 2025) |
| RE-* | 418 | 175 | 243 (vor 2025) |

**Grund f√ºr Differenz:** `hero-document-sync` filtert auf `date >= '2025-01-01'`

**5. Cron-Job Status:**
- Schedule: `*/5 6-19 * * *` (alle 5 Min, 6-19 Uhr)
- Status: aktiv (automatisch l√§uft tags√ºber)

### Dokumentation

- D016: Softr-Betr√§ge-Backup aufbewahren (`docs/softr_amounts_backup.json`)
- D017: Hero-Sync Betr√§ge nur √ºberschreiben wenn Quelle Wert hat
- L041: Upsert √ºberschreibt existierende Werte mit NULL/0

---

## LOG-016 - Schlussrechnung-Nachweis-Check Edge Function

**Datum:** 2026-01-28 ~19:00-23:00
**Dauer:** ~2 Stunden

### Zusammenfassung

Edge Function `schlussrechnung-nachweis-check` v16 erstellt, die bei NU-Schlussrechnungen (ER-NU-S) automatisch pr√ºft, ob Nachweise fehlen und E-Mails an NUs sendet.

### Durchgef√ºhrte Arbeiten

**1. Edge Function v16 (Final):**
- Findet ER-NU-S Dokumente in `dokumente`-Tabelle
- Matched mit Monday-Projekten via ATBS-Nummer (text49__1)
- Pr√ºft 4 Nachweis-Felder:
  - `color_mkt2e02p`: Nachweis Rohinstallation Elektrik
  - `color_mkt2hpg0`: Nachweis Rohinstallation Sanit√§r
  - `color_mkt2t435`: Nachweis Abdichtung Bad
  - `color_mkt2t62x`: E-Check Protokoll
- Test-Modus mit `test_email` Parameter

**2. E-Mail-Template (Du-Form):**
- Anrede: "Hallo Vitali" (Vorname)
- Text: "danke f√ºr deine Schlussrechnung", "Bitte lade..."
- Button: Rot (#dc3545), eckig, mittig, wei√üe Schrift
- Link: https://neurealis-partnerportal.softr.app/anmeldung
- BCC: tobias.rangol@neurealis.de (Produktivmodus)

**3. Parameter:**
```json
{
  "atbs_filter": ["ATBS-445"],  // Optional: nur bestimmte BVs
  "dokument_nr": "RE20250157",  // Optional: einzelnes Dokument
  "mode": "check" | "send",     // check = nur pr√ºfen, send = E-Mails senden
  "test_email": "..."           // Optional: alle E-Mails an diese Adresse
}
```

**4. Test-Ergebnis:**
- ATBS-445 (RE20250157): 4 offene Nachweise ‚Üí E-Mail gesendet
- ATBS-447 (RE 20260155): 4 offene Nachweise ‚Üí E-Mail gesendet

**5. Gel√∂ste Probleme:**

| Problem | L√∂sung |
|---------|--------|
| Supabase Client JSONB-Filter | Direct REST API + manuelles Filtern |
| PostgREST LIKE-Syntax | %25 statt * f√ºr Wildcard |
| email-send JWT-Auth | verify_jwt: false gesetzt |

### N√§chste Schritte (Future)

- Trigger erstellen f√ºr automatische Ausf√ºhrung bei neuen ER-NU-S
- Cron-Job f√ºr t√§gliche Pr√ºfung aller offenen Nachweise

---

## LOG-015 - Hero PDF-Sync - Vollst√§ndige Migration

**Datum:** 2026-01-28 ~18:00
**Dauer:** ~30 Minuten

### Zusammenfassung

Alle 653 PDFs von Hero Software vollst√§ndig nach Supabase Storage migriert. GraphQL-Query und Filename-Sanitization gefixt.

### Durchgef√ºhrte Arbeiten

**1. hero-document-sync v11:**
- Fix: `temporary_url` zur GraphQL-Query hinzugef√ºgt (fehlte!)
- 728 Dokumente mit Hero OTC URLs aktualisiert

**2. hero-pdf-sync v3 ‚Üí v4:**
- Fix v3: Tabelle `softr_dokumente` (VIEW) ‚Üí `dokumente` (TABLE) korrigiert
- Fix v4: Filename-Sanitization f√ºr Supabase Storage hinzugef√ºgt
  - Umlaute (√§‚Üíae, √∂‚Üíoe, √º‚Üíue, √ü‚Üíss)
  - Sonderzeichen ‚Üí Underscore
  - Mehrfache Underscores entfernt

**3. Ergebnis:**
| Metrik | Wert |
|--------|------|
| Gefunden in Hero | 653 |
| Heruntergeladen | 653 |
| Hochgeladen | 653 |
| DB aktualisiert | 653 |
| Fehler | 0 |
| Dauer | ~89 Sekunden |

**4. Aktueller Stand:**
- 686 PDFs in Supabase Storage (permanent)
- 447 PDFs in S3 (Legacy, noch zu migrieren)
- 16 Softr-Dokumente ohne externe PDF-Quelle (Gutschriften, Budgets)

### Neue Learnings

- L039: Hero GraphQL - `file_upload { temporary_url }` explizit abfragen
- L040: Supabase Storage - Dateinamen mit Umlauten sanitizen

---

## LOG-014 - E-Mail-Integration Phase 1

**Datum:** 2026-01-28 ~14:00-16:00
**Dauer:** ~120 Minuten

### Zusammenfassung

E-Mail-Integration Phase 1 implementiert: MS365 Graph API ‚Üí Supabase. E-Mails und Anh√§nge werden automatisch importiert, in Supabase Storage gespeichert und als Dokumente angelegt.

### Durchgef√ºhrte Arbeiten

**1. Edge Functions:**
- `email-fetch` v4: Holt E-Mails von 6 MS365-Postf√§chern via Graph API
- `email-process`: Matching-Kaskade f√ºr Kontakt/BV-Zuordnung vorbereitet

**2. Datenbank-Tabellen (NEU):**
- `email_details`: E-Mail-spezifische Metadaten, verkn√ºpft mit dokumente
- `email_accounts`: 6 Postf√§cher konfiguriert
- `kontakt_domains`: Domain ‚Üí Kontakt Mapping
- `email_sync_log`: Audit-Log f√ºr Sync-Vorg√§nge

**3. Gel√∂ste Probleme:**

| Problem | L√∂sung |
|---------|--------|
| Graph API liefert contentBytes nicht in Liste | Jeden Anhang einzeln abrufen |
| UNIQUE-Constraint blockiert Anh√§nge | COALESCE f√ºr attachment_id im Index |
| Storage-Pfade mit Sonderzeichen | `<>@.` aus Message-ID entfernen |
| Modul-Import fehlgeschlagen | getApplicationAccessToken inlined |

**4. Ergebnis:**
- 50 E-Mails importiert (10 pro Postfach)
- 27 Anh√§nge in Supabase Storage hochgeladen
- 2 erwartete Fehlschl√§ge (.url, .ics - nicht in MIME-Types)

**5. Postf√§cher aktiv:**
- holger.neumann@neurealis.de
- service@neurealis.de
- rechnungen@neurealis.de
- bewerbungen@neurealis.de
- kontakt@neurealis.de
- auftraege@neurealis.de (keine E-Mails)

### Neue Learnings

- L035: UNIQUE Constraint mit NULL-Werten ‚Üí COALESCE verwenden
- L036: Graph API Attachments ‚Üí contentBytes einzeln abrufen
- L037: Storage-Pfad-Sanitization f√ºr Message-IDs
- L038: E-Mail-Import Architektur dokumentiert

### N√§chste Schritte

1. Cron-Jobs aktivieren (email-fetch: 10 Min, email-process: 15 Min)
2. email-process testen: Kontakt-Zuordnung, BV-Matching
3. Optional: .ics/.url zu MIME-Types hinzuf√ºgen

---

## LOG-013 - Angebotsvergleich ANG-0021296 (Vorher/Nachher)

**Datum:** 2026-01-28 ~12:30
**Dauer:** ~10 Minuten

### Zusammenfassung

Analyse der versehentlichen Preis√§nderungen im Angebot ANG-0021296. Vergleich auf Gesamtpositions- und Einzelpositionsebene durchgef√ºhrt.

### Durchgef√ºhrte Analyse

**1. Gesamtdifferenz:**
- VORHER: 47.561,96 ‚Ç¨ netto
- NACHHER: 58.053,05 ‚Ç¨ netto
- Differenz: **+10.491,09 ‚Ç¨** (+22%)

**2. Hauptursachen der Erh√∂hung:**

| Rang | Position | √Ñnderung | Grund |
|------|----------|----------|-------|
| 1 | Pos. 9 Strangsanierung | +6.126,79 ‚Ç¨ | Bedarf ‚Üí Aktiv |
| 2 | Pos. 6 Hauseingangst√ºr | +2.350,00 ‚Ç¨ | Bedarf ‚Üí Aktiv |
| 3 | Pos. 4 Treppenaufarbeitung | +1.169,00 ‚Ç¨ | Bedarf ‚Üí Aktiv |
| 4 | Pos. 3 Malervlies | +1.089,71 ‚Ç¨ | Teilweise aktiviert |
| 5 | Pos. 2 Innenwand | +813,47 ‚Ç¨ | Bedarf ‚Üí Aktiv |
| 6 | Pos. 7 Deckenbrennstellen | +525,00 ‚Ç¨ | 1‚Üí3 St√ºck |

**3. Einzige Einheitspreis-√Ñnderung:**
- Pos. 2.006 "√ñffnungen bis 2,5m¬≤ schlie√üen": 310,00 ‚Üí 346,86 ‚Ç¨/Stk (+11,9%)
- Auswirkung: +73,72 ‚Ç¨ (bei 2 St√ºck)

**4. Auff√§lligkeiten:**
- Demontage-Positionen (1.001-1.008) komplett entfernt im neuen Angebot
- Viele Bedarfspositionen wurden versehentlich aktiviert

### Ergebnis

Tabellen mit Vorher/Nachher-Vergleich auf Einzelpositionsebene erstellt.

---

## LOG-012 - Hero Document Sync v10 + Monday Bidirektional Sync

**Datum:** 2026-01-28 ~09:30-11:00
**Dauer:** ~90 Minuten

### Zusammenfassung

Hero Document Sync v10 deployed mit direktem Supabase-Upsert. Neue monday-push Edge Function f√ºr bidirektionalen Monday.com Sync. NUA-Budget-Berechnung (75% von AB) f√ºr VBW-Projekte implementiert.

### Durchgef√ºhrte Arbeiten

**1. Hero Document Sync v10:**
- 651 Dokumente von Hero nach Supabase synchronisiert
- Fehler behoben: Unique Constraint auf `dokument_nr` hinzugef√ºgt
- Fehler behoben: Default UUID f√ºr `id`-Spalte hinzugef√ºgt

**2. NUA-Budget-Berechnung:**
- Formel: 75% der Summe aller AB-Betr√§ge pro ATBS-Nummer
- Betroffen: NUA-367, NUA-368, NUA-369, NUA-370
- Rohertrag: 25% Marge standardm√§√üig

**3. monday-push Edge Function (NEU):**
- Bidirektionaler Monday.com Sync (Push von Supabase nach Monday)
- Feld-Mapping:
  - `zahlen1__1` = Projektvolumen netto
  - `zahlen77__1` = Projektvolumen brutto
  - `numeric65__1` = NU-Budget netto
  - `text23__1` = NUA-Nr
- 3 Items erfolgreich gepusht (ATBS-468, 469, 470)

**4. Datenbank-Fixes:**
```sql
ALTER TABLE dokumente ADD CONSTRAINT dokumente_dokument_nr_unique UNIQUE (dokument_nr);
ALTER TABLE dokumente ALTER COLUMN id SET DEFAULT gen_random_uuid()::text;
```

### Ergebnisse

| Metrik | Wert |
|--------|------|
| Dokumente synced | 651 |
| NUAs aktualisiert | 4 |
| Monday Items gepusht | 3 |
| Neue Edge Functions | 1 (monday-push) |

---

## LOG-011 - Hero Webhook-Recherche + Cron-Optimierung

**Datum:** 2026-01-28 ~09:00
**Dauer:** ~15 Minuten

### Zusammenfassung

Recherche zu Hero Software Webhooks und Optimierung des Document Sync Cron-Jobs.

### Recherche-Ergebnis: Hero hat KEINE Webhooks

Die Hero GraphQL API v7 unterst√ºtzt nur:
- **Queries:** `contacts`, `project_matches`, `customer_documents`, `calendar_events`, `supply_product_versions`
- **Mutations:** `create_contact`, `create_project_match`, `add_logbook_entry`

**Keine Subscriptions, Webhooks oder Event-Callbacks.**

Make.com "Watch Documents" Modul = **Polling** (nicht echte Webhooks).

### Cron-Job Optimierung

Der `hero-document-sync` Job wurde angepasst:

| Eigenschaft | Vorher | Nachher |
|-------------|--------|---------|
| Schedule | `*/15 * * * *` | `*/5 6-19 * * *` |
| Intervall | Alle 15 Min | Alle 5 Min |
| Zeitraum | 24/7 | 06:00 - 19:55 Uhr |
| L√§ufe/Tag | 96 | 168 (nur tags√ºber) |

### SQL-Migration

```sql
SELECT cron.alter_job(
  job_id := 17,
  schedule := '*/5 6-19 * * *'
);
```

### Quellen

- [HERO API-Dokumentation](https://hero-software.de/api-doku)
- [HERO GraphQL Guide](https://hero-software.de/api-doku/graphql-guide)
- [HERO Schnittstellen](https://hero-software.de/features/schnittstellen)

---

## LOG-010 - Document Summarization System

**Datum:** 2026-01-28 ~04:15-04:30
**Dauer:** ~15 Minuten

### Zusammenfassung

Implementierung eines automatischen Document Summarization Systems mit GPT-5.2. PDF-Text-Extraktion und KI-Zusammenfassung f√ºr alle nativen PDFs.

### Durchgef√ºhrte Arbeiten

**1. Edge Function `document-summarize` v5:**
- PDF-Text-Extraktion mit unpdf (pdfjs)
- Native vs. Scanned Klassifizierung (>500 chars/Seite = native)
- GPT-5.2 Zusammenfassung f√ºr native PDFs
- Batch-Verarbeitung mit konfigurierbarem Limit

**2. API-Parameter Fix:**
- Problem: GPT-5.2 unterst√ºtzt nicht `max_tokens`
- L√∂sung: `max_completion_tokens` statt `max_tokens` verwenden
- Learning L028 dokumentiert

**3. Datenbank:**
- `document_summaries` Tabelle erstellt
- Felder: `dokument_nr`, `zusammenfassung`, `is_native`, `processed_at`
- 27 Dokumente verarbeitet (25 native, 2 gescannt)

**4. Automatisierung (Hybrid-Ansatz):**
- Cron-Job `document-summarize-job` f√ºr Backlog
  - Schedule: alle 15 Minuten, 20 Docs/Batch
  - **Auto-Disable:** Deaktiviert sich selbst wenn Backlog leer
- Trigger `on_document_pdf_added` f√ºr neue Dokumente
  - Feuert bei INSERT oder UPDATE von `datei_url`
  - Ruft Edge Function mit einzelnem `dokument_nr` auf

**5. Hilfsfunktionen:**
- `check_document_backlog_empty()` - Pr√ºft ob noch Dokumente offen sind
- `disable_document_summarize_cron()` - Deaktiviert den Cron-Job
- `system_logs` Tabelle f√ºr Nachvollziehbarkeit

### Statistiken

| Metrik | Wert |
|--------|------|
| Dokumente mit PDFs | 1.071 |
| Bereits verarbeitet | 27 |
| Davon native | 25 |
| Davon gescannt | 2 |
| Noch offen | ~1.044 |
| Gesch√§tzte Dauer | ~13 Stunden |

### N√§chste Schritte

- [ ] Embeddings f√ºr Summaries generieren (vector(1536))
- [ ] RAG-Integration f√ºr Dokumenten-Suche
- [ ] Scanned PDFs durch OCR verarbeiten

---

## LOG-009 - Dokumenten-Merge + RAG-Vorbereitung

**Datum:** 2026-01-28 ~03:30-04:15
**Dauer:** ~45 Minuten (fortgesetzt aus vorheriger Session)

### Zusammenfassung

Konsolidierung der Dokumenten-Tabellen und Vorbereitung f√ºr RAG/CAG-Wissensmanagement. PDF-Sync-Analyse f√ºr permanente URLs.

### Durchgef√ºhrte Arbeiten (vorherige Session)

**1. Tabellen-Merge:**
- `softr_dokumente` (1.751 Docs) + `dokumente` (6 Docs) ‚Üí einheitliche `dokumente` Tabelle
- 1.835 Dokumente gesamt

**2. Neue Felder f√ºr RAG/CAG:**
- `is_native_pdf` - PDF-Klassifizierung (nativ vs. gescannt)
- `quelle` - Dokumentenherkunft (Hero, Softr, etc.)
- `raw_text` - Extrahierter Text
- `summary` - KI-generierte Zusammenfassung
- `embedding` - vector(1536) f√ºr Similarity-Search
- `atbs_nummer_erkannt`, `positionen_erkannt`, `gewerke_erkannt`, `keywords`, `entities`

**3. Edge Functions erstellt:**
- `classify-pdf` - PDF-Text-Extraktion mit unpdf
- `summarize-document` - GPT-5.2 Dokumentenanalyse
- `document-batch` - OpenAI Batch API f√ºr g√ºnstigere Verarbeitung

**4. Referenz-Tabelle:**
- `dokumenttypen` - 24 Dokumenttypen mit Kategorien und Keywords

**5. PDF-Extraktion:**
- 291 Dokumente mit raw_text extrahiert
- 37 als gescannt klassifiziert (ben√∂tigen OCR)
- ~99% der PDFs sind nativ (>500 chars/Seite)

### Aktuelle Session

**Status-Analyse:**
```
URL-Typ                    | Anzahl
---------------------------|-------
Supabase Storage           | 624 ‚úÖ
Softr S3 (ablaufend)       | 447 ‚ö†Ô∏è
Keine URL                  | 764 ‚ùå
```

**Edge Function `hero-pdf-sync`:**
- Bereits deployed und funktionsf√§hig
- 642 Hero-PDFs bereits zu Supabase Storage synchronisiert
- Dateinamen-Sanitization (Umlaute ‚Üí ae/oe/ue im Dateinamen)

### Offene Punkte

- [ ] 447 Dokumente mit ablaufenden S3-URLs migrieren
- [ ] 764 Dokumente ohne URL aus Hero nachladen
- [ ] OpenAI Batch-Job Ergebnisse verarbeiten
- [ ] Embeddings f√ºr extrahierte Dokumente generieren

---

## LOG-008 - Hero-Softr Dokumenten-Sync Bereinigung

**Datum:** 2026-01-28 ~02:00-03:30
**Dauer:** ~90 Minuten

### Zusammenfassung

Vollst√§ndige Bereinigung und Synchronisation der Dokumenten-Tabelle zwischen Hero und Softr/Supabase. Neue Edge Function f√ºr PDF-Sync erstellt.

### Durchgef√ºhrte Arbeiten

**1. Datenanalyse (3 parallele Subagenten):**
- Hero 2025: 642 Dokumente mit PDFs
- Softr: 2.000 Eintr√§ge, davon 501 Duplikate (25%)
- Kritisch: ANG-0021294 existierte 159x

**2. Duplikate bereinigt:**
- 299 Duplikate gel√∂scht
- ANG-0021294: 159 ‚Üí 1
- NUA-358: 36 ‚Üí 1

**3. Dokumenttypen korrigiert:**
- 28 Rechnungen von AR-A (Abschlag) zu AR-S (Schluss) korrigiert
- Basierend auf Hero `invoice_style: full`

**4. Fehlende Dokumente angelegt:**
- 128 neue Eintr√§ge (72 AR-S, 19 AFM, 16 AR-A, 15 Stornos)
- Neuer Dokumenttyp: AFM (Aufma√ü)

**5. Edge Function `hero-pdf-sync` erstellt:**
- 642 PDFs von Hero ‚Üí Supabase Storage gesynct
- Dateinamen-Sanitization (Umlaute, Leerzeichen)
- URL: `https://mfpuijttdgkllnvhvjlu.supabase.co/functions/v1/hero-pdf-sync`
- Parameter: `?dry_run=true`, `?limit=N`

### Neue Edge Function

```
hero-pdf-sync
‚îú‚îÄ‚îÄ Holt alle Hero-Dokumente mit PDFs
‚îú‚îÄ‚îÄ Downloaded von temporary_url
‚îú‚îÄ‚îÄ Uploaded zu Supabase Storage (softr-files/hero-docs/)
‚îî‚îÄ‚îÄ Updated datei_url in softr_dokumente
```

### Statistik nach Bereinigung

| Metrik | Vorher | Nachher |
|--------|--------|---------|
| softr_dokumente Eintr√§ge | 2.000 | 1.777 |
| Duplikate | 501 | 0 |
| Mit datei_url | 545 | 1.187 |
| Korrekte Dokumenttypen | ~90% | 100% |

---

## LOG-007 - OAuth Callback Verifizierung

**Datum:** 2026-01-28 ~01:30
**Dauer:** ~5 Minuten

### Zusammenfassung

Verifizierung der OAuth-Callback-Route nach User-Meldung √ºber Redirect zu localhost:3000.

### Durchgef√ºhrte Arbeiten

- Auth-Callback Route gepr√ºft (`/auth/callback/+server.ts`) - korrekt implementiert
- Login-Seite gepr√ºft - verwendet `window.location.origin` f√ºr dynamischen Redirect
- Hooks-Server gepr√ºft - Session-Handling funktioniert

### Ergebnis

OAuth funktioniert. Route war korrekt, Problem lag vermutlich an Supabase URL-Konfiguration oder Caching.

### Wichtige URLs f√ºr Supabase Auth

Falls Problem erneut auftritt:
- **Site URL:** `https://neurealis-erp.netlify.app`
- **Redirect URLs:** `https://neurealis-erp.netlify.app/auth/callback`
- **Dashboard:** https://supabase.com/dashboard/project/mfpuijttdgkllnvhvjlu/auth/url-configuration

---

## LOG-001 - UI-Migration Phase 1-2: Komplettes internes Portal

**Datum:** 2026-01-27 19:00-20:00
**Dauer:** ~60 Minuten

### Zusammenfassung

Vollst√§ndige Migration des internen Softr-Portals zu SvelteKit mit Supabase-Datenanbindung.

### Durchgef√ºhrte Arbeiten

**Phase 1 - Layout-System:**
- AppShell, Sidebar (rollenbasiert), Header, BottomNav erstellt
- UI-Komponenten: Button, Card, Badge, Accordion, KPICard
- Design-Tokens erweitert (Breakpoints, Status-Farben)

**Phase 2 - Seiten mit Supabase:**
| Seite | Tabelle | Datens√§tze |
|-------|---------|------------|
| Dashboard | diverse | KPIs, Aktivit√§ten |
| Bauvorhaben | monday_bauprozess | 193 |
| Kalender | monday_bauprozess | Bauzeitenplan |
| M√§ngel | maengel_fertigstellung | 57 |
| Nachtr√§ge | nachtraege | aktiv |
| Finanzen | softr_dokumente | 2.000 |
| Einkauf | grosshaendler, bestellartikel, lv_positionen | 2.835 |
| Kontakte | kontakte | 1.379 |
| Leads | leads (NEU!) | 8 |
| Aufgaben | tasks | 1.755 |
| Nachunternehmer | kontakte + kontakte_nachunternehmer | 39 |

**Neue Datenbank-Tabelle:**
- `leads` mit Pipeline-Status (neu, kontaktiert, qualifiziert, angebot, gewonnen, verloren)
- `softr_dokumente` mit 2.000 importierten Rechnungen

### Technische Details

- Svelte 5 Runes ($state, $derived, $props)
- Parallele Subagenten f√ºr schnelle Implementierung (11 parallel)
- TypeScript durchg√§ngig
- Responsive Design (Desktop + Mobile)

### Offene Punkte

- Kundenportal-Seiten: /angebote, /ansprechpartner
- Partnerportal-Seiten: /auftraege, /lvs, /nachweise, /vorlagen
- Auth-Rollen aus DB laden (derzeit hardcoded)
- Netlify Deploy

---

## LOG-002 - Hero API Rechnungssync - invoice_style Entdeckung

**Datum:** 2026-01-27 ~20:00
**Quelle:** Wiederherstellung aus abgest√ºrztem Chat

### Zusammenfassung

Analyse der Hero GraphQL API zur direkten Unterscheidung von Teil- und Schlussrechnungen mittels `metadata.invoice_style`.

### Kernentdeckung

Die Hero API bietet ein **InvoiceStyle Enum**:

| Wert | Bedeutung | ‚Üí Softr-Typ |
|------|-----------|-------------|
| `full` | Schlussrechnung | AR-S |
| `parted` | Teilrechnung | AR-A |
| `cumulative` | Kumulierte Rechnung | AR-A |
| `downpayment` | Abschlagsrechnung | AR-A |
| `null` | Entwurf | **Ignorieren** |

### Wichtige API-Felder

```graphql
customer_documents {
  nr                          # RE-0015xxx
  value                       # Netto EUR
  vat                         # MwSt EUR
  date                        # Datum
  metadata {
    invoice_style             # full/parted/cumulative/downpayment/null
    positions { name net_value vat }
  }
  file_upload {
    filename                  # Lesbarer Name
    url                       # Download-URL
  }
}
```

### Statistiken

- 53 Schlussrechnungen (full)
- 16 Teilrechnungen (parted)
- 1 kumulierte Rechnung
- 49 Entw√ºrfe (null) ‚Üí ignorieren

### Validierung

15 Dokumente verglichen: **100% √úbereinstimmung** zwischen Hero `invoice_style` und Softr-Dokumenttyp.

### Erstellte Dokumentation

- `docs/HERO_RECHNUNGSSYNC_API.md` - Vollst√§ndige API-Referenz

### N√§chste Schritte

1. [ ] Edge Function `hero-document-sync` anpassen
2. [ ] Fehlende Netto/Brutto in Supabase erg√§nzen
3. [ ] Positionen als Text-Feld speichern (optional)

---

## LOG-003 - VBW LV 2026 - Preisvergleich & Materialvorschl√§ge

**Datum:** 2026-01-27 ~21:00-22:30
**Zweck:** Verhandlungsvorbereitung mit Gro√ükunde VBW

### Zusammenfassung

Analyse des neuen VBW-Leistungsverzeichnisses 2026 mit Preisvergleich zu 2023 und Extraktion von Materialvorschl√§gen f√ºr Verhandlungsgespr√§ch.

### Durchgef√ºhrte Arbeiten

**1. Excel-Analyse:**
- Original-Excel mit 125 Zeilen, 22 Kommentare extrahiert
- Kommentare enthielten Materialvorschl√§ge und Preishinweise
- Umlaute-Encoding korrigiert

**2. Erstellte Ausgabe-Datei:**
`2026-01-27 VBW - LV 2026 - Preisvorschl√§ge neurealis.xlsx`

**Spaltenstruktur:**
| Spalte | Inhalt |
|--------|--------|
| A | Pos. NEU |
| B | Kurztext NEU (2026) |
| C | Gewerk |
| D | LV 2023 (50m¬≤) |
| E | LV 2026 (50m¬≤) |
| F | Œî % |
| G | Preisvorschlag (nur wenn explizit) |
| H | Material-Vorschlag |
| I | Kommentar (Original) |
| J | Vergleichsposition (andere Kunden) |

**3. Supabase-Vergleich:**
- Vergleichspositionen aus `lv_positionen` f√ºr GWS, covivio, WBG L√ºnen, Privat, neurealis

### Kritische Preis√§nderungen (50m¬≤ netto)

| Pos | Position | 2023 | 2026 | Œî |
|-----|----------|------|------|---|
| 3.1 | Sanit√§r komplett | 3.980 ‚Ç¨ | 7.650 ‚Ç¨ | **+92%** |
| 4.8 | Therme Vaillant | 2.650 ‚Ç¨ | 4.300 ‚Ç¨ | **+62%** |
| 6.1 | Bodenbel√§ge entf. | 480 ‚Ç¨ | 350 ‚Ç¨ | **-27%** |
| 6.3 | Vinyl | 2.075 ‚Ç¨ | 1.565 ‚Ç¨ | **-25%** |

### Materialvorschl√§ge f√ºr VBW

| Position | Vorschlag |
|----------|-----------|
| E-Anlage / Schalter | Gira Standard 55 (statt S2) |
| Sanit√§r | Vigour One |
| Fliesen | Kermos 8mm (DK02 nicht rutschhemmend) |
| T√ºren | Pr√ºm R√∂hrenspahn / KK2 RC2 |
| Beschl√§ge | Becher/Hoppe Amsterdam |

### Erkenntnisse f√ºr Verhandlung

1. **Untergrundvorbereitung fehlt im VBW-LV:**
   - S√§ubern + Grundieren nicht in 6.2 enthalten
   - GWS hat separate Positionen (Grundierung 2,63‚Ç¨/m¬≤, Untergrund 14,58‚Ç¨/m¬≤)

2. **Explizite Preisvorschl√§ge aus Kommentaren:**
   - 4.9 R√ºckbau MAG: 250‚Ç¨ (Stadtwerke-Abmeldung aufwendig)
   - 7.2 WE-T√ºr: 1.200‚Ç¨ (EK Material 1.050‚Ç¨)

### Erstellte Scripts

- `parse-vbw-excel.mjs` - Excel-Struktur analysieren
- `create-vbw-material-excel.mjs` - Erste Extraktion
- `update-vbw-final.mjs` - Finale Ausgabe mit Vergleichen

---

---

## LOG-004 - VBW LV 2026 - Entscheidungsgrundlage v1.1 (Final)

**Datum:** 2026-01-27 ~23:00
**Zweck:** Finales Verhandlungsdokument f√ºr VBW-Termin 28.01.2026

### Zusammenfassung

Professionelles Entscheidungsdokument f√ºr Preisverhandlung mit VBW erstellt. Enth√§lt Ausrei√üer-Analyse, Materialvorschl√§ge, Prozessoptimierung und Zahlungsziel-Argumentation.

### Finale Dateien

| Datei | Pfad |
|-------|------|
| **PDF (Final)** | `16 VBW - neu/00 LVs/2026 VBW - Neues LV mit 10er Schritten/2026-01-27 VBW - LV 2026 - Entscheidungsgrundlage - neurealis v1.1.pdf` |
| **DOCX (Final)** | `16 VBW - neu/00 LVs/2026 VBW - Neues LV mit 10er Schritten/2026-01-27 VBW - LV 2026 - Entscheidungsgrundlage - neurealis v1.1.docx` |

**Basispfad:** `C:\Users\holge\neurealis GmbH\Wohnungssanierung - Kunden - Kunden\`

### Dokumentstruktur (8 Seiten)

1. **Titelseite** - Vorher/Nachher Visualisierung
2. **Inhaltsverzeichnis**
3. **Zusammenfassung der Analyse**
   - Vorgehen: LV 2023‚Üí2026, 3 Referenz-BVs, GWS-Marktvergleich
   - Referenz-Wohnungen: In der Delle 6 (37m¬≤), Schulenburgstr. 25 (58m¬≤), Gorch-Fock 31 (76m¬≤)
4. **√úbersicht Positionen mit Gespr√§chsbedarf** (sortiert nach Abweichung)
5. **Detailanalyse kritische Positionen**
6. **Materialvorschl√§ge**
7. **Zahlungsziel** (14 Tage netto beibehalten)
8. **Prozessoptimierung** mit Leerstandskosten-Berechnung
9. **Entscheidungspunkte** (6 St√ºck)

### Ausrei√üer-Analyse (Top 5)

| Pos. | Position | VBW 2026 | Markt | Œî |
|------|----------|----------|-------|---|
| 3.3 | K√ºchenstr√§nge erneuern | 350 ‚Ç¨ | 1.268 ‚Ç¨ | **-72%** |
| 1.5 | Elektroschlitze verputzen | 250 ‚Ç¨ | 543 ‚Ç¨ | **-54%** |
| 2.1 | E-Anlage komplett | 2.740 ‚Ç¨ | 4.929 ‚Ç¨ | **-44%** |
| 6.3 | Vinyl-Designboden | 1.565 ‚Ç¨ | 2.617 ‚Ç¨ | **-40%** |
| - | Decken tapezieren | 770 ‚Ç¨ | 1.077 ‚Ç¨ | **-29%** |

### Leerstandskosten-Berechnung (NEU)

```
280 Wohnungen/Jahr √ó 3 Wochen Verz√∂gerung √ó 60m¬≤ √ó 8,50 ‚Ç¨/m¬≤/Monat √∑ 4 Wochen
= 357.000 ‚Ç¨/Jahr potenzielle Einsparung
```

### Prozessoptimierung - Zeitachse

| Phase | Aktuell | Vorschlag |
|-------|---------|-----------|
| Monat 0 | K√ºndigung Mieter | K√ºndigung + BL-Zuweisung (nach Stra√üen) |
| Monat 1-2 | - | Erstbegehung (bewohnte Wohnung) |
| Monat 2-3 | - | Budgetfreigabe & Einplanung |
| Monat 3 | Auszug ‚Üí +3 Wochen ‚Üí Baustart | Auszug ‚Üí **Direkter Baustart** |

### 6 Entscheidungspunkte

1. Positionen mit Gespr√§chsbedarf ‚Üí Preisanpassung/Leistungsumfang
2. Materialvorgaben ‚Üí Freigabe Alternativen
3. Zahlungsziel ‚Üí 14 Tage netto beibehalten
4. Prozessoptimierung ‚Üí Umsetzung neuer Ablauf
5. BL-Zuordnung ‚Üí Feste Zuordnung nach Stra√üen/Regionen
6. Kapazit√§tsplanung ‚Üí (offen)

### Materialvorschl√§ge (genehmigt)

| Pos. | Aktuell | Vorschlag |
|------|---------|-----------|
| 2.1, 2.8 | Gira E2 | **Gira Standard 55** |
| 2.7 | Ritzer Limodor | **Maico ECA 100 ipro K** |
| 3.1 | diverse | **Vigour One** |
| 5.9 | DK02 | **Kermos 8mm** (rutschhemmend!) |
| 6.3 | Holz-Sockelleisten | **KSO Kunststoff** |
| 7.1 | Jeld-Wen | **Pr√ºm R√∂hrenspahn** |
| 7.2 | Jeld-Wen | **Pr√ºm KK2 RC2** |
| 7.3 | Griffwerk | **Becher/Hoppe Amsterdam** |

### Verkn√ºpfung

- Basiert auf: LOG-003 (Preisvergleich & Materialvorschl√§ge)
- Excel-Quellen: `2026-01-27 VBW - LV 2026 - Vorschl√§ge neurealis.xlsx`, `2026-01-27 VBW - LV 2026 - Preisvergleich vs 2023 - Beispiel-Berechnungen & Vorschl√§ge Material.xlsx`

---

---

## LOG-005 - UI CRUD + Netlify Deployment

**Datum:** 2026-01-28 ~22:00-23:30
**Zweck:** Alle UI-Seiten editierbar machen und live deployen

### Zusammenfassung

Vollst√§ndiges CRUD (Create, Read, Update, Delete) f√ºr alle UI-Seiten implementiert und erfolgreich auf Netlify deployed.

### Implementierte CRUD-Funktionalit√§t

| Seite | Create | Read | Update | Delete | Details |
|-------|--------|------|--------|--------|---------|
| **BV-Detail** | - | ‚úÖ | ‚úÖ | - | Kunde, Termine, Kennzahlen, Nachweise editierbar |
| **M√§ngel** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Modal, Quick-Status-Actions, Fotos-URLs |
| **Nachtr√§ge** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Modal, Auto-Marge-Berechnung |
| **Aufgaben** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Slide-over Panel, Checkbox f√ºr Erledigt |
| **Kontakte** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (Soft) | Modal mit Sektionen, E-Mail-Validierung |
| **Nachunternehmer** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ (Soft) | 3-Tab-Modal: Stammdaten, Gewerke, Nachweise |
| **Finanzen** | - | ‚úÖ | - | - | Erweiterte Filter, √úberf√§llig-Tracking |

### Phasen-Visualisierung (BV-Detail)

- Nummern oben in eckigen Boxen
- Phasen-Namen darunter (Desktop: voll, Tablet: kurz, Mobile: nur Nr)
- Farbschema: Gr√ºn (erledigt), Rot (aktiv), Grau (zuk√ºnftig)

### Technische Details

- 6 parallele Subagenten f√ºr CRUD-Implementierung
- Svelte 5 $state f√ºr reaktives State-Management
- Loading/Success/Error States √ºberall
- Best√§tigungs-Dialoge beim L√∂schen
- Optimistic UI Updates
- Soft-Delete f√ºr Kontakte und NUs

### Netlify Deployment

**Problem:** Erster Deploy zeigte 404 - nur `build/` Ordner ohne Functions deployed.

**L√∂sung:** `netlify deploy --prod` ohne `--dir` Flag verwenden, damit Netlify die `.netlify/functions-internal/` mit deployed.

**URL:** https://neurealis-erp.netlify.app

### Git Commits

1. `143c136` - feat: UI-Migration Softr ‚Üí SvelteKit komplett (50 Dateien, +23k Zeilen)
2. `9864cfe` - chore: Cleanup + Edge Functions Update
3. `a172db1` - feat: Vollst√§ndiges CRUD f√ºr alle UI-Seiten (+7.5k Zeilen)
4. `262800b` - fix: Svelte @const placement in nachunternehmer

### Behobene Fehler

1. **Svelte @const Placement:** `{@const}` muss innerhalb `{#if}` oder `{#each}` sein, nicht direkt in `<div>`
2. **Netlify Functions:** adapter-netlify generiert Functions in `.netlify/`, nicht in `build/`

---

## LOG-006 - Hero Document Sync v7 + Datenqualit√§ts-Analyse

**Datum:** 2026-01-28 ~00:00-01:30
**Zweck:** invoice_style Implementierung und Sync-Ausf√ºhrung

### Zusammenfassung

Edge Function `hero-document-sync` auf v7 aktualisiert mit `metadata.invoice_style` als prim√§re Klassifizierungslogik. Sync ausgef√ºhrt und Datenqualit√§t analysiert.

### Implementierung

**Edge Function √Ñnderungen:**
```typescript
const INVOICE_STYLE_TO_SOFTR: Record<string, string> = {
  'full': 'AR-S  Ausgangsrechnung - Schluss',
  'parted': 'AR-A  Ausgangsrechnung - Abschlag',
  'cumulative': 'AR-A  Ausgangsrechnung - Abschlag',
  'downpayment': 'AR-A  Ausgangsrechnung - Abschlag'
};
```

**GraphQL Query erweitert:**
- `metadata { invoice_style }` hinzugef√ºgt
- `file_upload { filename }` f√ºr bessere Dateinamen
- Batch-Size von 100 auf 500 erh√∂ht (Performance)

### Sync-Ergebnis

| Metrik | Wert |
|--------|------|
| Hero-Dokumente gepr√ºft | 642 |
| Rechnungen korrekt | 146 (keine √Ñnderung) |
| Typ-Korrekturen | **0** |
| Update fehlgeschlagen | ~200 (neue Dokumente) |

**Erkenntnis:** Die alte Fallback-Logik (Phase/Rechnungsnummer) funktionierte bereits gut - alle Typen waren korrekt.

### Datenqualit√§ts-Analyse (softr_dokumente)

**NUA-Dokumente:**
| Problem | Anzahl | Anteil |
|---------|--------|--------|
| Ohne betrag_netto | 181 | **80%** |
| Duplikate | 62 | 27% |
| Ohne ATBS-Zuweisung | 70 | 31% |

**Allgemeine Probleme:**
- projektname nur bei 41.65% gef√ºllt
- datei_url nur bei 40.75% vorhanden
- Inkonsistente Dokumenttypen (AB vs AB mit Umlaut)

### Offene Punkte

- [ ] Neue Dokumente (ANG, NUA, AB) automatisch in Softr anlegen (derzeit nur Update)
- [ ] NUA-Werte aus Hero synchronisieren (80% fehlen)
- [ ] Duplikate bereinigen (62 St√ºck)
- [ ] Projekt-Zuweisungen vervollst√§ndigen

### Erstellte Dokumentation

- `docs/HERO_RECHNUNGSSYNC_API.md` - Vollst√§ndige API-Referenz (aktualisiert)

---

## LOG-041: CPQ-System QA-Pruefung (T6)

**Datum:** 2026-01-31
**Status:** Abgeschlossen

### Durchgefuehrte Pruefungen

1. **DB-Struktur:** 9/9 Tabellen vorhanden
   - lv_config: 3 LV-Typen (GWS 46, VBW 23, neurealis 35 Gewerke)
   - angebots_bausteine: 44 Eintraege
   - position_dependencies: 138 Abhaengigkeiten

2. **Edge Function:** transcription-parse v2 aktiv

3. **TypeScript:** 2 Fehler gefunden und behoben

4. **Svelte-Komponenten:** Alle 6 Dateien korrekt

5. **Imports:** Alle Imports verifiziert

6. **API-Route:** position-correction funktional

7. **Sidebar:** Link zu /angebote vorhanden

### Fixes

| Problem | Loesung |
|---------|---------|
| TypeScript Type-Export aus Svelte-Komponenten | Neue types.ts Datei erstellt, Imports aktualisiert |

**Geaenderte Dateien:**
- `ui/src/lib/components/cpq/types.ts` (NEU)
- `ui/src/lib/components/cpq/index.ts`
- `ui/src/lib/components/cpq/PositionItem.svelte`
- `ui/src/lib/components/cpq/PositionGroup.svelte`
- `ui/src/lib/components/cpq/PositionGroupList.svelte`
- `ui/src/routes/angebote/neu/+page.svelte`

### Ergebnis

**BESTANDEN** - Alle kritischen Pruefungen erfolgreich

**Offene TODOs (nicht-kritisch):**
- PDF-Generierung implementieren
- Manuelle Position hinzufuegen implementieren
- NUA-Detection implementieren

### Erstellte Dokumentation

- `docs/implementation/t6_qa_result.md`

---

## LOG-064 - monday_bauprozess Spalten-Umbenennung mit Pr√§fixen

**Datum:** 2026-02-01 ~18:00
**Dauer:** ~15 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Spalten in `monday_bauprozess` mit eindeutigen Pr√§fixen umbenannt f√ºr bessere Zuordnung (NU, BL, AG).

### Durchgef√ºhrte Arbeiten

**1. SQL-Migration:**
- Name: `rename_monday_bauprozess_columns_with_prefixes`
- Version: 20260201180404

**Umbenannte Spalten:**

| Kategorie | Alt | Neu |
|-----------|-----|-----|
| **NU** | nachunternehmer | nu_firma |
| | ansprechpartner | nu_ansprechpartner |
| | telefon_ansprechpartner | nu_telefon |
| | email_ansprechpartner | nu_email |
| **BL** | bauleiter | bl_name |
| | bauleiter_email | bl_email |
| | bauleiter_telefon | bl_telefon |
| **AG** | kundenname | ag_name |
| | kundennummer | ag_nummer |
| | email_kunde | ag_email |
| | telefon_kunde | ag_telefon |

**2. Edge Functions aktualisiert + redeployed:**
- `monday-sync` v17 - COLUMN_MAPPING
- `monday-push` v12 - REVERSE_COLUMN_MAPPING
- `telegram-webhook` v73 - PROJEKT_SPALTEN + Queries
- `audio-briefing-generate` v5 - Interfaces + Queries

**3. Dokumentation:**
- `docs/learnings.md` L144 aktualisiert
- `docs/status_quo.md` neuer Abschnitt

### Pr√§fix-Konvention (NEU)

| Pr√§fix | Bedeutung | Beispiele |
|--------|-----------|-----------|
| `nu_` | Nachunternehmer | nu_firma, nu_email |
| `bl_` | Bauleiter | bl_name, bl_telefon |
| `ag_` | Auftraggeber | ag_name, ag_nummer |
| (ohne) | Projekt-Stammdaten | atbs_nummer, budget, baustart |

### Learnings

- L145: Spalten mit Pr√§fix benennen f√ºr Eindeutigkeit (nu_, bl_, ag_)

---

## LOG-066 - Monday-Sync Initial + verify_jwt Fix

**Datum:** 2026-02-01 ~18:30
**Dauer:** ~10 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Monday-Sync initial ausgef√ºhrt und `verify_jwt` Problem f√ºr Cron-Jobs behoben.

### Durchgef√ºhrte Arbeiten

**1. Problem identifiziert:**
- `monday-sync` v17 hatte `verify_jwt: true`
- pg_net/Cron-Calls schlugen fehl: `401 Missing authorization header`

**2. Fix:**
- `monday-sync` v18 deployed mit `verify_jwt: false`
- Initial-Sync erfolgreich ausgef√ºhrt

**3. Sync-Ergebnis:**
| Spalte | Bef√ºllt | Prozent |
|--------|---------|---------|
| `nu_firma` | 201/201 | 100% |
| `nu_ansprechpartner` | 201/201 | 100% |
| `bl_name` | 201/201 | 100% |
| `bl_email` | 197/201 | 98% |
| `ag_name` | 201/201 | 100% |
| `ag_email` | 201/201 | 100% |

### Learnings

- L146: Edge Functions mit `verify_jwt: false` f√ºr Cron/Trigger-basierte Calls

---

## LOG-067 - Telegram-Bot v74: Status/Gewerke kombiniert + Men√º-Optimierung + PDF

**Datum:** 2026-02-01 ~19:30
**Dauer:** ~45 Minuten
**Status:** Abgeschlossen

### Zusammenfassung

Telegram-Bot v74: Status und Gewerk-Status zu einem Men√ºpunkt kombiniert, Hauptmen√º-Reihenfolge f√ºr Bauleiter optimiert, User Guide PDF mit Titelseite aktualisiert.

### Durchgef√ºhrte Arbeiten

**1. Status & Gewerke kombiniert:**
- `showProjektStatus()` erweitert: Zeigt jetzt Gewerk-Tabelle mit Plan (Ausf√ºhrungsart) + Ist (Status)
- Neue Konstante `GEWERK_KOMBINIERT` mit Monday-Spalten-IDs f√ºr Plan + Ist
- Buttons "üèóÔ∏è Gewerk-Status" und "üìê Ausf√ºhrungsarten" entfernt ‚Üí Alles in "üìä Status & Gewerke"

**2. Men√º-Reihenfolge optimiert (f√ºr Bauleiter):**
| Vorher | Nachher |
|--------|---------|
| Aufma√ü | ‚≠ê Favoriten |
| Bedarfsanalyse | üîç ATBS direkt |
| Baustelle | üèóÔ∏è Baustelle |
| ATBS direkt | üìä Aufma√ü |
| Audio-Briefing | üéôÔ∏è Audio-Briefing |
| - | üìù Bedarfsanalyse |

**3. "Nachricht an NU" ausgeblendet:**
- Button aus Projekt-Men√º entfernt
- Backend-Logik bleibt erhalten (bau:nachricht:nu Callback funktioniert weiterhin)

**4. PDF User Guide aktualisiert:**
- 6 Seiten: Titelseite ‚Üí Einleitung ‚Üí Projekt √∂ffnen ‚Üí M√§ngel/Nachtr√§ge ‚Üí Nachweise/Status ‚Üí Men√ºbaum
- Datum und Uhrzeit auf jeder Seite oben rechts
- Version 74 durchgehend

**5. Version korrigiert:**
- Im Code waren v71 und v74 Features, aber Header sagte v61
- Korrigiert auf v74 im Header

### Ge√§nderte Dateien

- `supabase/functions/telegram-webhook/index.ts` (v74)
- `docs/TELEGRAM_BOT_USER_GUIDE.html`
- `docs/TELEGRAM_BOT_USER_GUIDE.pdf`

### Learnings

- L147: Men√º-Reihenfolge f√ºr Bauleiter: ATBS-Schnellzugriff direkt nach Favoriten

---

*Aktualisiert: 2026-02-01 19:45*
